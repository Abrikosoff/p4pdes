\documentclass{tufte-book}

\hypersetup{colorlinks}

\title{PETSc for PDEs}
\author{Ed Bueler}
\publisher{Maybe Someday a Publisher of This Book}

\date{\today}

\usepackage{booktabs} % for nicely-typeset tabular material
\usepackage{verbatim} % for "comment" environment
\usepackage{xspace}
\usepackage{fancyvrb}
\usepackage{graphicx}
\usepackage{amsmath,amssymb}

% macros

\newcommand{\trueinput}[2]{
\VerbatimInput[frame=single,framesep=3mm,label=\fbox{\normalsize \textsl{\,#1\,}},fontfamily=courier,fontsize=\footnotesize]{#2}
}

\newcommand*\FancyVerbStartString{fill string}
\newcommand*\FancyVerbStopString{fill string}

%\cinputraw{FILENAME}{FILENAMEROOT}{CAPTION}{PARTSTRING}{STARTSTRING}{STOPSTRING}
\newcommand{\cinputraw}[6]{
\renewcommand*\FancyVerbStartString{#5}
\renewcommand*\FancyVerbStopString{#6}
\begin{figure*}
\vspace{0.8cm}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\normalsize \textsl{\,#2\,}#4},%
               fontfamily=courier,%
               fontsize=\small]{#1}
\vspace{0.5cm}
\caption{#3}
\end{figure*}
}

\newcommand{\cinput}[4]{%
    \cinputraw{cstrip/#1}{#1}{#2}{}{#3}{#4}}
\newcommand{\cinputnostrip}[4]{%
    \cinputraw{../c/#1}{#1}{#2}{}{#3}{#4}}

\newcommand{\cinputpart}[5]{%
    \cinputraw{cstrip/#1}{#1}{#2}{\quad \textbf{part #3}}{#4}{#5}}
\newcommand{\cinputpartnostrip}[5]{%
    \cinputraw{../c/#1}{#1}{#2}{\quad \textbf{part #3}}{#4}{#5}}

\newcommand{\caveat}[1]{\marginnote{\textsc{Where we stand:}\\  #1}}

% Prints an epigraph and speaker in sans serif, all-caps type.
\newcommand{\openepigraph}[2]{%
  %\sffamily\fontsize{14}{16}\selectfont
  \begin{fullwidth}
  \sffamily\large
  \begin{doublespace}
  \noindent\allcaps{#1}\\% epigraph
  \noindent \Large \allcaps{#2}% author
  \end{doublespace}
  \end{fullwidth}
}

\newcommand{\bA}{\mathbf{A}}
\newcommand{\bB}{\mathbf{B}}
\newcommand{\bE}{\mathbf{E}}
\newcommand{\bF}{\mathbf{F}}
\newcommand{\bJ}{\mathbf{J}}

\newcommand{\bn}{\mathbf{n}}
\newcommand{\br}{\mathbf{r}}
\newcommand{\bx}{\mathbf{x}}

\newcommand{\CC}{\mathbb{C}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\eps}{\epsilon}
\newcommand{\lam}{\lambda}
\newcommand{\lap}{\triangle}

\newcommand{\Div}{\ensuremath{\nabla\cdot}}
\newcommand{\Curl}{\ensuremath{\nabla\times}}
\newcommand{\grad}{\nabla}

\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}
\newcommand{\Matlab}{\textsc{Matlab}\xspace}

\newcommand{\onull}{\operatorname{null}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\range}{\operatorname{range}}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

\newcommand{\PETSc}{\textsc{PETSc}\xspace}

\newcommand{\pDM}{{\texttt{DM}}}
\newcommand{\pDMPlex}{{\texttt{DMPlex}}}
\newcommand{\pKSP}{{\texttt{KSP}}}
\newcommand{\pMat}{{\texttt{Mat}}}
\newcommand{\pSNES}{{\texttt{SNES}}}
\newcommand{\pTS}{{\texttt{TS}}}
\newcommand{\pVec}{{\texttt{Vec}}}

% eventually this is a good idea:
%\usepackage{makeidx}
%\makeindex

\begin{document}

\frontmatter

% epigraph page first
\newpage\thispagestyle{empty}
\openepigraph{%
\dots when there are disputes among persons, we can simply say: Let us calculate, without further ado, to see who is right.
}{Gottfried Wilhelm Leibniz}
\vfill
\openepigraph{%
Developing parallel, nontrivial PDE solvers that deliver high performance is still difficult and requires months (or even years) of concentrated effort.  PETSc is a toolkit that can ease these difficulties and reduce the development time, but it is not a black-box PDE solver, nor a silver bullet
}{Barry Smith}
\vfill
\openepigraph{%
Tufte's style is known
for its extensive use of sidenotes, tight integration of graphics with
text, and well-set typography.
}{The Tufte-LaTeX\ Developers}
\vfill

\maketitle

\tableofcontents

\begin{comment}
% dedication
\cleardoublepage
~\vfill
\begin{doublespace}
\noindent\fontsize{18}{22}\selectfont\itshape
\nohyphenation
Thanks to \mbox{Jed Brown} and \mbox{Constantine Khroulev}, fellow students, and gurus.
\end{doublespace}
\vfill
\end{comment}

%%%%%%%%%%

\chapter{Why this book?}

The Portable, Extensible Toolkit for Scientific computing (\PETSc\sidenote{Say it ``pets sea.''}) is a library built on the standard software layer for large-scale parallel computation, the Message Passing Interface (MPI).

\PETSc is not new software.  Version 2.0, the first to make an impact in the scientific computing world, was built in 1994.  A well-known textbook \citet{Smithetal1996}\sidenote{B.~Smith, P.~Bjorstad, and W.~Gropp. \emph{Domain decomposition: parallel multilevel methods for elliptic partial differential equations}. Cambridge
University Press, 1996} uses \PETSc 2.0 for scalable solutions of linear partial differential equations (PDEs) through pre-conditioned iterative linear solvers.  For example, domain decomposition methods like additive Schwarz are shown to solve the Poisson equation on irregular domains and fine meshes in parallel.

But \PETSc is now at version 3.5, and it has transformed into something better.\sidenote{Version 3.5.2 is current in September 2014.  The stable homepage URL for PETSc, including download and installation instructions, is at \href{http://www.mcs.anl.gov/petsc/index.html}{www.mcs.anl.gov/petsc}.}  Typical examples and applications now emphasize solving nonlinear PDEs at scale.  The 21st-century \PETSc strategy is to compose Newton's method and mesh topology tools---these new parts of the \PETSc API are highly-visible to modern library users---with a run-time chooseable selection of preconditioners and iterative linear solvers.  ``Multiphysics problems''\sidenote{As far as I can tell this buzzword just refers to a diverse system of coupled PDEs with nontrivial scalings among the variables.  That's a concept that \emph{needs} a buzzword.} are now within reach.  \PETSc may not be a silver bullet, but users now see powerful tools to solve hard problems.

On the other hand, \PETSc is notoriously complicated.  So perhaps a new book is needed.

This book should help you solve nonlinear PDEs by writing C code that calls \PETSc methods.  It tries to both explain the ideas directly and illustrate the ideas through example codes.  The example codes come with enough background information so that they can be the basis for further developments.  Demonstrated scalability of these examples is the goal, which means runtime options are explained and compared.

This book does not replace the \PETSc \emph{User's Manual}.  For one thing, the current book assumes you want to solve PDEs, while there are many other uses of \PETSc.  The reader should at least know which topics are addressed in the \emph{User's Manual}, even if searching online is the first resort for resolving compile-time errors or for exposing the API.

\section{What I need from you, the reader}  

Some of the mathematical theory\sidenote{\citep{Evans} is recommended.} of PDEs must be familiar to you, but I will also assume some (nebulous, and hard to define) intuition about nonlinear PDE problems.\sidenote{\citep{Ockendonetal2003} is recommended.}  Of course, all applied mathematicians, distinctly including this author, are wanting when it comes to complete mathematical theory and complete intuition for nonlinear PDEs.

Numerical ideas from linear algebra \citep{TrefethenBau} arise in this book, but so will multiple numerical discretization strategies for PDEs.  Thus at least one numerical PDE paradigm must be in the reader's toolbox.  This numerical background might be based on finite differences \citep{MortonMayers}, but I will assume you seek to apply the finite element method (FEM) on unstructured grids.  The basics of the FEM method will be reviewed, but the reader must bring some background understanding of this nontrivial topic.\sidenote{\citet{Elmanetal2005}, \citet{Braess}, and \citet{KarniadakisSherwin} are all recommended, but we will follow Elman most closely.}  Perhaps the weak form of a PDE, and the idea of assembling the systems of equations element-by-element, are ``rusty'' topics.  But these topics must be there somewhere.


\section{There is much that this book does NOT do}  Here is a partial list:\begin{itemize}
\item This book does not help you install \PETSc.
\item This book does not replace a good online tutorial on getting started in \PETSc.
\item This book does not replace \citep{Smithetal1996}.
\item This book does not do anything in Fortran.
\item This book does not help with the many packages \PETSc links to.
\item This book does not do a good job teaching the FEM.
\item This book does not help much if your PDE problem is hyperbolic.
\item This book does not consider spatial dimensions except 2 and 3.
\item This book does not prove anything.\sidenote{We do give evidence for convergence and scalability when possible.}
\item This book does not care whether its numerical solutions are good models of physical problems.
\item This book does not adequately cover what is known about nonlinear PDEs, much less what is not known.
\end{itemize}


\section{Who are you, reader?}  

You've taken a mathematics course or two in PDEs.  Somewhere you picked up a bit of coding in C; perhaps you do it every day.  You've written various scientific codes in \Matlab or python.  You've tried numerical PDE methods.  But \emph{now you want it all in parallel on big problems}.  This book is for you.  And me.


\mainmatter

%%%%%%%%%

\input{getstarted.tex} % chapter 1

%%%%%%%%%%

\input{linear.tex} % chapter 2

%%%%%%%%%%

\chapter{3. Nonlinear elliptic PDEs on structured grids}

\section{Newton's method}

\section{\textsc{SNES}}

%\cinput{c3newton.c}{}

\section{Structured grids in \PETSc}

%\cinput{c3poisson.c}{}

\section{Example: a porous medium equation}

%\cinput{c3porous.c}{}

\section{Jacobians: actual and approximate}

\section{Indeterminant systems: Stokes}

%\cinput{c3stokes.c}{}

\caveat{But it isn't scaling well yet.}

%%%%%%%%%%

\chapter{4. Multigrid and run-time composition}

\section{\textsc{DM}}

\caveat{But \PETSc should help with unstructured meshes too.}

%%%%%%%%%%

\chapter{5. Unstructured grids}

\section{\textsc{DMPlex}}

%\cinput{c5poisson.c}{}

\caveat{But my PDE has ``$t$'' in it.}

%%%%%%%%%%

\chapter{6. Time-evolving problems}

\section{\textsc{TS}}

%\cinput{c6freesurface.c}{}

\caveat{But my PDE isn't really a PDE.  It has an inequality in it.}

%%%%%%%%%%

\chapter{7. PDEs with constraints}

\section{A variational inequality problem}

%\cinput{c7obstacle.c}{}

%%%%%%%%%%

\backmatter

\bibliography{ice-bib}
\bibliographystyle{plainnat}

\end{document}
