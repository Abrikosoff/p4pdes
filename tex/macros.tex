
% the goal here is to have a display of code with a separate "Code x.y" numbering
% and with the caption in the margin
\DeclareFloatingEnvironment[placement={!ht},name=Code]{mycodeenv}
\captionsetup[mycodeenv]{labelfont=bf}
% next line duplicates declaration of environment "marginfigure" in tufte-common.def
\newenvironment{margincode}[1][-1.2ex]%
  {\begin{@tufte@margin@float}[#1]{mycodeenv}}
  {\end{@tufte@margin@float}}

\newcommand{\trueinput}[2]{
\VerbatimInput[frame=single,framesep=3mm,label=\fbox{\normalsize \textsl{\,#1\,}},fontfamily=courier,fontsize=\footnotesize]{#2}
}

%\inputfromline{FULLPATH}{FILENAME}{CAPTION}{FIRSTLINE}{LABEL}
\newcommand{\inputfromline}[5]{
\vspace{0.8cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}},%
               fontfamily=courier,%
               fontsize=\footnotesize,%
               firstline=#4]{#1}
\end{minipage}
\vspace{0.5cm}
\begin{margincode}[1.0cm]
\caption{#3}
\label{#5}
\end{margincode}
\vspace{1.5cm}
}

\newcommand{\inputwhole}[4]{\inputfromline{#1}{#2}{#3}{1}{#4}}

%\cinputraw{FULLPATH}{FILENAMESHOWN}{CAPTION}{PARTSTRING}{STARTSTRING}{STOPSTRING}{LABEL}
\newcommand{\cinputraw}[7]{
\newcommand*\FancyVerbStartString{#5}
\newcommand*\FancyVerbStopString{#6}
\vspace{0.8cm}
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}#4},%
               fontfamily=courier,%
               fontsize=\footnotesize]{#1}
\end{minipage}
\vspace{0.5cm}
\begin{margincode}[1.0cm]
\caption{#3}
\label{#7}
\end{margincode}
\vspace{1.5cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
}

\newcommand{\cinput}[6]{%
    \cinputraw{cstrip/#1}{#2#1}{#3}{}{#4}{#5}{#6}}

\newcommand{\cinputpart}[7]{%
    \cinputraw{cstrip/#1}{#2#1}{#3}{\quad \textbf{part #4}}{#5}{#6}{#7}}

\newcommand{\cinputpartnostrip}[7]{%
    \cinputraw{#1}{#2}{#3}{\quad \textbf{part #4}}{#5}{#6}{#7}}

\DefineVerbatimEnvironment{code}{Verbatim}
{fontsize=\small,frame=lines,framerule=0.2mm,framesep=2.0mm,xleftmargin=5mm}

\DefineVerbatimEnvironment{codeplain}{Verbatim}
{fontsize=\small,xleftmargin=5mm}

\DefineVerbatimEnvironment{cline}{Verbatim}
{fontsize=\small,frame=leftline,framerule=0.3mm,framesep=2.0mm}


\newcommand{\complabel}[2]{#1 \\ \footnotesize #2}
\newcommand{\usedlabel}[2]{\complabel{#1}{\emph{#2}}}

% usage: \standardstack{scale}{objective}{Jacobian}{TS}{DMDA}{DMPlex}
%   where last 5 args are either "dashed" or empty
\def \standardstack#1#2#3#4#5#6{
\begin{tikzpicture}[scale=#1,
                    >={Latex[length=2mm]},
  component/.style={
     rectangle,draw,fill=white,align=center,line width=1pt},
  userfcn/.style={
     rounded corners,draw,fill=white,draw,align=center,line width=1pt,font={\itshape,\normalsize}}]

\draw[line width=1pt] (3,8) node[userfcn,minimum width=80mm] (usercode) {user code \\ \vspace{10mm}};
\draw[line width=1pt] (-0.5,8.2) node[userfcn,#2] (objcode) {objective};
\draw[line width=1pt] (3,7.5) node[userfcn] (rescode) {residual};
\draw[line width=1pt] (6.7,8.2) node[userfcn,#3] (jaccode) {Jacobian};

\draw[line width=1pt] (-4,4.7) node[component,#4] (ts) {\complabel{\pTS}{time-stepping}};

\draw[line width=1pt] (-0.5,4) node[component] (snes) {\complabel{\pSNES}{nonlinear solver}};
\draw[line width=1pt] (-0.5,2) node[component] (ksp)  {\complabel{\pKSP}{linear solver}};
\draw[line width=1pt] (-0.5,0) node[component] (pc)   {\complabel{\pPC}{preconditioner}};

\draw[line width=1pt] (4,4) node[component,#5] (dmda) {\complabel{\pDMDA}{structured grid}};
\draw[line width=1pt,dashed] (8.5,4.5) node[component,#6] (dmplex) {\complabel{\pDMPlex}{mesh}};

\draw[line width=1pt] (3,0) node[component] (matj)   {\usedlabel{\pMat}{Jacobian}};
\draw[line width=1pt] (7,0) node[component] (vecs)   {\pVecs \\ \footnotesize  \emph{solution, other fields}};

\path
   ([xshift=2em]objcode.south) edge[->,bend right,distance=6.5em,#2] node {} (vecs)
   ([xshift=2em]rescode.south) edge[->,bend left] node {} ([xshift=2.5em]vecs.north)
   ([xshift=1em]jaccode.south) edge[->,#3] node {} ([xshift=1em]vecs.north)
   (jaccode.south) edge[->,bend left,#3] node {} (matj)
   ([xshift=-13em]usercode.south) edge[->,#4] node {} (ts)
   ([xshift=-10em]usercode.south) edge[->] node {} (snes)
   ([xshift=2em]usercode.south) edge[->,#5] node {} (dmda)
   ([xshift=14em]usercode.south) edge[->,#6] node {} (dmplex)
   ([xshift=9em]usercode.south) edge[->] node {} (vecs)
   (ts) edge[#4] node {} (snes)
   (snes) edge node {} (ksp)
   (ksp) edge node {} (pc);
\end{tikzpicture}
}

\newcommand{\bA}{\mathbf{A}}
\newcommand{\bB}{\mathbf{B}}
\newcommand{\bE}{\mathbf{E}}
\newcommand{\bF}{\mathbf{F}}
\newcommand{\bG}{\mathbf{G}}
\newcommand{\bJ}{\mathbf{J}}
\newcommand{\bR}{\mathbf{R}}
\newcommand{\bU}{\mathbf{U}}

\newcommand{\bb}{\mathbf{b}}
\newcommand{\bc}{\mathbf{c}}
\newcommand{\be}{\mathbf{e}}
\newcommand{\bbf}{\mathbf{f}} % \bf already defined
\newcommand{\bg}{\mathbf{g}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\bp}{\mathbf{p}}
\newcommand{\bq}{\mathbf{q}}
\newcommand{\br}{\mathbf{r}}
\newcommand{\bs}{\mathbf{s}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bv}{\mathbf{v}}
\newcommand{\bw}{\mathbf{w}}
\newcommand{\bx}{\mathbf{x}}
\newcommand{\by}{\mathbf{y}}
\newcommand{\bz}{\mathbf{z}}

\newcommand{\CC}{\mathbb{C}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\X}{\times}  % for nonzero entries in matrices

\newcommand{\XX}{$\bm{\times}$}  % for ticks in tables
\newcommand{\gX}{{\color{Gray} $\times$}}

\newcommand{\eps}{\epsilon}
\newcommand{\lam}{\lambda}
\newcommand{\lap}{\triangle}

\newcommand{\Div}{\ensuremath{\nabla\cdot}}
\newcommand{\Curl}{\ensuremath{\nabla\times}}
\newcommand{\grad}{\nabla}

\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}

% iteration vec display in R^2
\newcommand{\twovect}[4]{\ensuremath{{#1}_{#2} =
                            \begin{bmatrix} #3 \\ #4 \end{bmatrix}}}
\newcommand{\rvect}[3]{\twovect{\bu}{#1}{#2}{#3}}

\newcommand{\cond}{\operatorname{cond}}
\newcommand{\onull}{\operatorname{null}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\range}{\operatorname{range}}
\newcommand{\Span}{\operatorname{span}}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

\newcommand{\Th}{\mathcal{T}_h}
\newcommand{\Pone}{\mathbf{P}_1}

\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\Triangle}{\textsc{triangle}\xspace}
\newcommand{\MPI}{\textsc{MPI}\xspace}

\newcommand{\PETSc}{\textsc{PETSc}\xspace}

\newcommand{\pDM}{\texttt{DM}\xspace}
\newcommand{\pDMs}{\texttt{DM}s\xspace}

\newcommand{\pDMDA}{\texttt{DMDA}\xspace}
\newcommand{\pDMDAs}{\texttt{DMDA}s\xspace}

\newcommand{\pDMPlex}{\texttt{DMPlex}\xspace}
\newcommand{\pDMPlexs}{\texttt{DMPlex}s\xspace}

\newcommand{\pIS}{\texttt{IS}\xspace}
\newcommand{\pISs}{\texttt{IS}s\xspace}

\newcommand{\pKSP}{\texttt{KSP}\xspace}
\newcommand{\pKSPs}{\texttt{KSP}s\xspace}

\newcommand{\pPC}{\texttt{PC}\xspace}
\newcommand{\pPCs}{\texttt{PC}s\xspace}

\newcommand{\pSNES}{\texttt{SNES}\xspace}
\newcommand{\pSNESs}{\texttt{SNES}s\xspace}

\newcommand{\pTS}{\texttt{TS}\xspace}
\newcommand{\pTSs}{\texttt{TS}s\xspace}

\newcommand{\pMat}{\texttt{Mat}\xspace}
\newcommand{\pMats}{\texttt{Mat}s\xspace}

\newcommand{\pVec}{\texttt{Vec}\xspace}
\newcommand{\pVecs}{\texttt{Vec}s\xspace}
