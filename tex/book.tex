\documentclass{tufte-book}

\hypersetup{colorlinks}

\usepackage{xspace}
\newcommand{\PETSCVERSION}{3.6\xspace}
\newcommand{\PETSCMINORVERSION}{3.6.0\xspace}
\newcommand{\PETSCMONTH}{June 2015\xspace}

\renewcommand{\maketitlepage}[0]{%
  \cleardoublepage%
  {%
  \sffamily%
  \begin{fullwidth}%
  \fontsize{18}{20}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{\thanklessauthor}}%
  \vspace{9pc}%
  \fontsize{32}{40}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{\thanklesstitle}}%
  \vfill%
    \fontsize{18}{40}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{numerical solutions using}}%
    \fontsize{18}{40}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{the Portable, Extensible Toolkit for Scientific computation}}%
    \fontsize{18}{40}\selectfont\par\noindent\textcolor{darkgray}{(for PETSc version \PETSCVERSION)}%
  \vfill%
  \fontsize{14}{16}\selectfont\par\noindent\allcaps{\thanklesspublisher}%
  \end{fullwidth}%
  }
  \thispagestyle{empty}%
  \clearpage%
}

\title[PETSc for PDEs]{PETSc \\ for \\ Partial \\ Differential \\ Equations}

\author{Ed Bueler}
\publisher{Maybe Someday a Publisher of This Book}

\date{\today}

\usepackage{booktabs} % for nicely-typeset tabular material
\usepackage{verbatim} % for "comment" environment
\usepackage{fancyvrb}
%\usepackage{underscore} % causes "Missing \endcsname inserted" error?
\usepackage{graphicx}
\usepackage{amsmath,amssymb,amsthm,bm}
\usepackage{tikz}

\usetikzlibrary{arrows,decorations.markings,decorations.pathreplacing,fadings}

%\usepackage[subtle,floats]{savetrees}

% macros

\theoremstyle{definition}
\newtheorem*{example}{{\color{cyan} Example}}
\newtheorem*{examplecont}{{\color{cyan} Example, continued}}

\newcommand{\trueinput}[2]{
\VerbatimInput[frame=single,framesep=3mm,label=\fbox{\normalsize \textsl{\,#1\,}},fontfamily=courier,fontsize=\footnotesize]{#2}
}

%\inputfromline{FULLPATH}{FILENAME}{CAPTION}{FIRSTLINE}{LABEL}
\newcommand{\inputfromline}[5]{
\vspace{0.8cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}},%
               fontfamily=courier,%
               fontsize=\footnotesize,%
               firstline=#4]{#1}
\end{minipage}
\vspace{0.5cm}

\begin{marginfigure}[1.0cm]
\caption{#3}
\label{#5}
\end{marginfigure}

\vspace{1.5cm}
}

%\inputtoline{FULLPATH}{FILENAME}{CAPTION}{LASTLINE}{LABEL}
\newcommand{\inputtoline}[5]{
\vspace{0.8cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}},%
               fontfamily=courier,%
               fontsize=\footnotesize,%
               lastline=#4]{#1}
\end{minipage}
\vspace{0.5cm}

\begin{marginfigure}[1.0cm]
\caption{#3}
\label{#5}
\end{marginfigure}

\vspace{1.5cm}
}

\newcommand{\inputwhole}[4]{\inputfromline{#1}{#2}{#3}{1}{#4}}

%\cinputraw{FULLPATH}{FILENAME}{CAPTION}{PARTSTRING}{STARTSTRING}{STOPSTRING}{LABEL}
\newcommand{\cinputraw}[7]{
\newcommand*\FancyVerbStartString{#5}
\newcommand*\FancyVerbStopString{#6}
\vspace{0.8cm}
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}#4},%
               fontfamily=courier,%
               fontsize=\footnotesize]{#1}
\end{minipage}
\vspace{0.5cm}

\begin{marginfigure}[1.0cm]
\caption{#3}
\label{#7}
\end{marginfigure}

\vspace{1.5cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
}

\newcommand{\cinput}[5]{%
    \cinputraw{cstrip/#1}{c/#1}{#2}{}{#3}{#4}{#5}}

\newcommand{\cinputpart}[6]{%
    \cinputraw{cstrip/#1}{c/#1}{#2}{\quad \textbf{part #3}}{#4}{#5}{#6}}
\newcommand{\cinputpartnostrip}[6]{%
    \cinputraw{../c/#1}{c/#1}{#2}{\quad \textbf{part #3}}{#4}{#5}{#6}}

\newcommand{\caveat}[1]{\marginnote{\textsc{Where we stand:}\\  #1}}

% Prints an epigraph and speaker in sans serif, all-caps type.
\newcommand{\openepigraph}[2]{%
  %\sffamily\fontsize{14}{16}\selectfont
  \begin{fullwidth}
  \sffamily\large
  \begin{doublespace}
  \noindent\allcaps{#1}\\% epigraph
  \noindent \Large \allcaps{#2}% author
  \end{doublespace}
  \end{fullwidth}
}

\DefineVerbatimEnvironment{code}{Verbatim}
{fontsize=\small,frame=lines,framerule=0.2mm,framesep=2.0mm,xleftmargin=5mm}

\DefineVerbatimEnvironment{cline}{Verbatim}
{fontsize=\small,frame=leftline,framerule=0.3mm,framesep=2.0mm}

\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}

\newcommand{\bA}{\mathbf{A}}
\newcommand{\bB}{\mathbf{B}}
\newcommand{\bE}{\mathbf{E}}
\newcommand{\bF}{\mathbf{F}}
\newcommand{\bJ}{\mathbf{J}}

\newcommand{\bb}{\mathbf{b}}
\newcommand{\bc}{\mathbf{c}}
\newcommand{\be}{\mathbf{e}}
\newcommand{\bbf}{\mathbf{f}} % \bf already defined
\newcommand{\bg}{\mathbf{g}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\bp}{\mathbf{p}}
\newcommand{\bq}{\mathbf{q}}
\newcommand{\br}{\mathbf{r}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bv}{\mathbf{v}}
\newcommand{\bw}{\mathbf{w}}
\newcommand{\bx}{\mathbf{x}}
\newcommand{\by}{\mathbf{y}}
\newcommand{\bz}{\mathbf{z}}

\newcommand{\CC}{\mathbb{C}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\X}{\times}  % for nonzero entries in matrices
\newcommand{\redX}{{\color{red} \bm{\underline{\X}}}}
\newcommand{\blueX}{{\color{blue} \bm{\underline{\X}}}}

\newcommand{\XX}{$\bm{\times}$}  % for ticks in tables
\newcommand{\gX}{{\color{Gray} $\times$}}

\newcommand{\eps}{\epsilon}
\newcommand{\lam}{\lambda}
\newcommand{\lap}{\triangle}

\newcommand{\Div}{\ensuremath{\nabla\cdot}}
\newcommand{\Curl}{\ensuremath{\nabla\times}}
\newcommand{\grad}{\nabla}

\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}

\newcommand{\cond}{\operatorname{cond}}
\newcommand{\onull}{\operatorname{null}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\range}{\operatorname{range}}
\newcommand{\Span}{\operatorname{span}}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

\newcommand{\Th}{\mathcal{T}_h}
\newcommand{\Pone}{\mathbf{P}_1}

\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\Triangle}{\textsc{triangle}\xspace}
\newcommand{\MPI}{\textsc{MPI}\xspace}

\newcommand{\PETSc}{\textsc{PETSc}\xspace}

\newcommand{\pDM}{\texttt{DM}\xspace}
\newcommand{\pDMDA}{\texttt{DMDA}\xspace}
\newcommand{\pDMPlex}{\texttt{DMPlex}\xspace}

\newcommand{\pKSP}{\texttt{KSP}\xspace}
\newcommand{\pPC}{\texttt{PC}\xspace}
\newcommand{\pSNES}{\texttt{SNES}\xspace}
\newcommand{\pTS}{\texttt{TS}\xspace}

\newcommand{\pMat}{\texttt{Mat}\xspace}
\newcommand{\pMats}{\texttt{Mat}s\xspace}

\newcommand{\pVec}{\texttt{Vec}\xspace}
\newcommand{\pVecs}{\texttt{Vec}s\xspace}

\setcounter{secnumdepth}{0}

% eventually this is a good idea:
%\usepackage{makeidx}
%\makeindex

\begin{document}

\begin{comment}
% epigraph page first
\newpage\thispagestyle{empty}
\openepigraph{%
\dots when there are disputes among persons, we can simply say: Let us calculate, without further ado, to see who is right.
}{Gottfried Wilhelm Leibniz}
\vfill
\openepigraph{%
Developing parallel, nontrivial PDE solvers that deliver high performance is still difficult and requires months (or even years) of concentrated effort.  PETSc is a toolkit that can ease these difficulties and reduce the development time, but it is not a black-box PDE solver, nor a silver bullet
}{Barry Smith}
\vfill
\openepigraph{%
Tufte's style is known for its extensive use of sidenotes, tight integration of graphics with text, and well-set typography.
}{The Tufte-LaTeX\ Developers}
\vfill

\frontmatter
\end{comment}

\maketitle


\newpage
\begin{fullwidth}
~\vfill
\thispagestyle{empty}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}
Copyright \copyright\ \the\year\ \thanklessauthor

\par\smallcaps{Published by \thanklesspublisher}

%\par  [license here] I have no idea if I should license this at this stage

\par\textit{First printing, \monthyear}
\end{fullwidth}

\tableofcontents


% Thanks to \mbox{Jed Brown} and \mbox{Constantine Khroulev}, fellow students, and gurus.

%%%%%%%%%%

\chapter*{Preface}

\section{Why read this book?}

Perhaps you've taken a mathematics course or two in partial differential equations (PDEs).  You may have written a few codes in C, or various short scripts in \Matlab or python.  You are interested in solving PDEs numerically for models which work in parallel on big problems.  This book is for you.

\section{Get the example codes}

Use \texttt{git} to get the example C codes, and \LaTeX\xspace sources for the book too:
\begin{cline}
$ git clone https://github.com/bueler/p4pdes.git
\end{cline}
%$
In the text we use the C codes in subdirectories \texttt{p4pdes/c/ch}$N$ for $N$ equal to the chapter number.

\section{What is \PETSc?}

The Portable, Extensible Toolkit for Scientific computing (\PETSc)\sidenote{Say it ``pets sea.''  The homepage for PETSc, including download and installation instructions, is \href{http://www.mcs.anl.gov/petsc/index.html}{www.mcs.anl.gov/petsc}.} is an open-source, mathematical software library built on top of the standard software layer for large-scale parallel computation, the Message Passing Interface (MPI) \citep{Groppetal1999}.  Thus \PETSc is a framework capable of solving problems like PDEs at ``large scale,'' that is, at high resolution and on supercomputers with hundreds to millions of cores.

\PETSc is not particularly new.  Version 2.0, the first version to make an impact in the scientific computing world, was built in 1994.  A well-known monograph \citet{Smithetal1996}\sidenote{B.~Smith, P.~Bjorstad, and W.~Gropp. \emph{Domain decomposition: parallel multilevel methods for elliptic partial differential equations}. Cambridge
University Press, 1996} uses \PETSc 2.0 for scalable solutions of linear partial differential equations (PDEs).  That book focusses on pre-conditioned iterative linear solvers and domain decomposition.  For example, methods like additive Schwarz are shown to scalably-solve the Poisson equation on irregular domains and fine meshes in parallel.

But \PETSc is now at version \PETSCVERSION.\sidenote{Version \PETSCMINORVERSION is current in \PETSCMONTH.}  It has evolved into a more powerful toolbox with a much richer API (application program interface).  Typical examples and applications are for nonlinear PDEs.  Indeed nonlinear, multigrid, and multiphysics\sidenote{This buzzword refers to a diverse system of coupled PDEs with nontrivial scalings among the variables.} parts of the API are now highly-visible to users.  The \PETSc strategy is to compose Newton's method and mesh topology tools with a run-time choice of preconditioners and iterative linear solvers.  \PETSc may not be a silver bullet, but it presents users with many powerful tools for solving hard problems, well beyond iterative linear algebra.  As twenty years have passed since version 2.0, perhaps a new book is appropriate.

\section{My goals}

This book is about numerically-solving linear and nonlinear PDEs in 2 or 3 spatial variables by writing C code that directly calls \PETSc.  It tries to both \emph{explain} the ideas and \emph{illustrate} them through example codes.  The example codes come with enough background information so that readers can use them as a basis for further developments.  Demonstrated scalability is the goal, so runtime options are explained and compared, especially in the exercises.

This book is written from the conviction that \emph{better access to common knowledge among experts} advances scientific computing as a discipline.  An expert in \PETSc may say about this book's content that ``I knew all that'' \emph{and} that ``this book is a fast on-ramp to what I already know.''  That is my hope!

\section{What I need from you, the reader}

To make sense of this book, some of the mathematical theory\sidenote{\citep{Evans} is recommended, but not really a prerequisite.} of PDEs must be familiar.  I will also assume some practical intuition about PDE problems, including exposure to nonlinear ones.\sidenote{\citep{Ockendonetal2003} is recommended.}  Of course, all applied mathematicians, distinctly including this author, are wanting when it comes to injesting the mathematical theory of, and building intuition for, nonlinear PDEs.

Multiple numerical discretization paradigms will arise here, but at least one numerical approach to PDEs should already be in the reader's toolbox.  That might be the finite element method (FEM) \citep{Braess,Elmanetal2005}, finite differences \citep{MortonMayers}, finite volumes \citep{LeVeque}, or spectral methods \citep{KarniadakisSherwin,Trefethen}.  Exposure to multigrid ideas \citep{Briggsetal2000} would be helpful, but these concepts will be reviewed.

Certainly numerical ideas from linear algebra \citep{Greenbaum1997,TrefethenBau} will appear, often with only a brief introduction.

Starting in Chapter 3 I will assume that you are interested in unstructured grids, though not at the exclusion of structured approaches.  The basics of the FEM method will be reviewed, but the reader with some background understanding will benefit most.\sidenote{Priority topics for review are the weak form of a PDE and the idea of assembling the equations element-by-element.}

Searching in the \PETSc HTML manual pages should be the reader's first resort for resolving compile-time errors.  The reader should review the \PETSc \emph{User's Manual} \citep{petsc-user-ref}, as it explains best why the API is designed in the way it is.


\section{There is much that this book does NOT do}

I'll assume you want to solve PDEs, but there are many other uses of \PETSc.  Furthermore, this book\begin{itemize}
\item  does not replace the \PETSc \emph{User's Manual},
\item  does not really help you install \PETSc,
\item  does not use Fortran or C++; all examples are in C though we use ANSI C99 features,
\item  does not help with most of the many packages \PETSc links to,
\item  does not do a complete job of teaching the FEM or any other discretization paradigm for PDEs,
\item  does not particularly care whether its numerical solutions are good models of physical problems---that is your job, not mine,
\item  does not consider spatial dimensions except 2 and 3,
\item  does not prove anything,\sidenote{We do give evidence for convergence and scalability when possible.} and
\item  does not adequately cover what is known about nonlinear PDEs, much less what is not known.
\end{itemize}


\mainmatter

%\setcounter{chapter}{0}

%%%%%%%%%

\input{getstarted.tex} % chapter 1

\input{linearsystem.tex} % chapter 2

\input{structured.tex} % chapter 3

\input{unstructured.tex} % chapter 4

\input{multigrid.tex} % chapter 5

\input{scaling.tex} % chapter 6

%%%%%%%%%%

\chapter{Nonlinear elliptic PDEs on structured grids}
\label{chap:nonlinear}

\section{Newton's method}

\section{\textsc{SNES}}
% c6newton.c

FIXME: somewhere in here we get to an idea that is most relevant to nonlinear problems: experimentation with linear solvers (i.e.~inside Newton) is obligatory because examples of linear systems can be found so that any solver comes out faster than any other \citep{Nachtigaletal1992} and examples of linear systems can be found so that well-known Krylov solvers like GMRES can be made to converge at any rate \citep{Greenbaumetal1996}

\section{Example: a porous medium equation}

\section{Jacobians: actual and approximate}

\caveat{But it isn't scaling well yet.}

%%%%%%%%%%

\input{stokes.tex} % chapter 8

%%%%%%%%%%

\chapter{Unstructured grids, the right way}
\label{chap:dmplex}

\section{\textsc{DMPlex}}

\caveat{But my PDE isn't really a PDE.  It has an inequality in it.}

%%%%%%%%%%

\input{constrained.tex} % chapter 10

%%%%%%%%%%

\backmatter

\bibliography{book}
\bibliographystyle{plainnat}

\clearpage

\newcommand{\tblockeqncode}[3]{
\begin{tabular}[t]{l} #1: \\ \qquad {\small #2} \\ \quad {\large \underline{\texttt{#3}}} \end{tabular}
}
\newcommand{\tblockcode}[2]{
\begin{tabular}[t]{l} #1 \\ \quad {\large \underline{\texttt{#2}}} \end{tabular}
}
\newcommand{\tblock}[1]{
\begin{tabular}[t]{l} #1 \end{tabular}
}

\thispagestyle{empty}
\noindent \textsc{inside front cover:}

\vfill
\begin{center}
\hspace{-10mm}\begin{tabular}{rllll}
\toprule
Chapter 
    &\quad linear\quad
          &linear
                &\quad nonlinear\quad
                      &nonlinear \\ 
    &     &time-dependent
                &     &time-dependent \\
\midrule  \bigskip
1   &     &     &     &      \\ \bigskip
2   & \tblockeqncode{Poisson}{$-\grad^2 u = f$}{c2poisson.c}
          & \tblockeqncode{heat}{$u_t = \grad^2 u$}{c2heat.c}
                &     &      \\ \bigskip
3   & \tblockcode{Poisson}{c3poisson.c}
          &     &     &      \\ \bigskip
4   & \begin{minipage}[t]{35mm}
 \tblockcode{Poisson}{c4poisson.c}

 \tblockeqncode{advection-diffusion}{$\bv \cdot \grad u - \grad^2 u = f$}{c4ad.c}
\end{minipage}
          &     &     &      \\ \bigskip
5   &     &     &     &      \\ \bigskip
6   &     &     & \tblockeqncode{$p$-Laplace}{$\begin{matrix} -\Div\left(D \grad u\right) = f \\ D = |\grad u|^{p-2} \end{matrix}$}{c6plap.c}
                      & \tblockeqncode{porous}{$\begin{matrix} u_t = \Div\left(D \grad u\right) \\ D = u^{\gamma-1} \end{matrix}$}{c6porous.c} \\ \bigskip
7   & \tblockeqncode{Stokes}{$\begin{matrix} -\grad^2 \bu + \grad p = 0 \\ \Div \bu = 0 \end{matrix}$}{c7stokes.c}
          &     &     &      \\ \bigskip
8   & \tblockcode{Poisson}{c8poisson.c}
          &     &     &      \\
    & \tblockcode{Stokes}{c8stokes.c}
          &     &     &      \\ \bigskip
9   &     &     & \tblockeqncode{obstacle}{$\begin{matrix} -\grad^2 u = f \\ u\ge \psi \end{matrix}$}{c9obstacle.c}
                      & \tblockeqncode{ice sheet}{$\begin{matrix} H_t = \Div\left(D \grad H\right) + f \\ D = H^{n+2} |\grad (H-b)|^{n-1} \\ H \ge 0\end{matrix}$}{c9ice.c} \\
\bottomrule
\end{tabular}
\end{center}
\vfill


\newpage\thispagestyle{empty}
\noindent \textsc{inside back cover:}

\vfill
\begin{center}
\begin{tabular}{rccccccc}
\toprule
Chapter 
    &\;\pVec\; &\;\pMat\;
                &\;\pKSP\; &\pDMDA
                            &\pDMPlex
                                  &\pSNES &\;\pTS\; \\
\midrule
1   & \XX & \XX & \XX &     &     &     &      \\
2   & \XX & \XX & \XX & \XX &     &     &      \\
3   & \XX & \XX & \XX &     &     &     &      \\
4   & \gX & \gX & \XX & \XX &     &     &      \\
5   & \gX & \gX & \XX & \XX &     &     &      \\
6   & \gX & \gX & \XX & \XX &     & \XX & \XX  \\
7   & \gX & \gX & \gX & \XX &     & \XX &      \\
8   & \gX & \gX & \XX &     & \XX & \XX &      \\
9   & \gX & \gX & \gX & \XX &     & \XX &      \\
\bottomrule
\end{tabular}
\end{center}
\vfill

\end{document}
