\documentclass{tufte-book}

\hypersetup{colorlinks}

\title[PETSc for PDEs]{PETSc \\ for \\ Partial \\ Differential \\ Equations}
\author{Ed Bueler}
\publisher{Maybe Someday a Publisher of This Book}

\date{\today}

\usepackage{booktabs} % for nicely-typeset tabular material
\usepackage{verbatim} % for "comment" environment
\usepackage{xspace}
%\usepackage{underscore} % causes "Missing \endcsname inserted" error?
\usepackage{fancyvrb}
\usepackage{graphicx}
\usepackage{amsmath,amssymb,amsthm,bm}
\usepackage{tikz}
\usetikzlibrary{arrows,decorations.markings}

%\usepackage[subtle,floats]{savetrees}

% macros

\theoremstyle{definition}
\newtheorem*{example}{{\color{cyan} Example}}

\newcommand{\trueinput}[2]{
\VerbatimInput[frame=single,framesep=3mm,label=\fbox{\normalsize \textsl{\,#1\,}},fontfamily=courier,fontsize=\footnotesize]{#2}
}

%\inputfromline{FULLPATH}{FILENAME}{CAPTION}{FIRSTLINE}{LABEL}
\newcommand{\inputfromline}[5]{
\vspace{0.8cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}},%
               fontfamily=courier,%
               fontsize=\scriptsize,%
               firstline=#4]{#1}
\end{minipage}
\vspace{0.5cm}

\begin{marginfigure}[1.0cm]
\caption{#3}
\label{#5}
\end{marginfigure}

\vspace{1.5cm}
}

\newcommand{\inputwhole}[4]{\inputfromline{#1}{#2}{#3}{1}{#4}}

%\cinputraw{FULLPATH}{FILENAME}{CAPTION}{PARTSTRING}{STARTSTRING}{STOPSTRING}{LABEL}
\newcommand{\cinputraw}[7]{
\newcommand*\FancyVerbStartString{#5}
\newcommand*\FancyVerbStopString{#6}
\vspace{0.8cm}
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}#4},%
               fontfamily=courier,%
               fontsize=\scriptsize]{#1}
\end{minipage}
\vspace{0.5cm}

\begin{marginfigure}[1.0cm]
\caption{#3}
\label{#7}
\end{marginfigure}

\vspace{1.5cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
}

\newcommand{\cinput}[5]{%
    \cinputraw{cstrip/#1}{#1}{#2}{}{#3}{#4}{#5}}
\newcommand{\cinputnostrip}[5]{%
    \cinputraw{../c/#1}{#1}{#2}{}{#3}{#4}{#5}}

\newcommand{\cinputpart}[6]{%
    \cinputraw{cstrip/#1}{#1}{#2}{\quad \textbf{part #3}}{#4}{#5}{#6}}
\newcommand{\cinputpartnostrip}[6]{%
    \cinputraw{../c/#1}{#1}{#2}{\quad \textbf{part #3}}{#4}{#5}{#6}}

\newcommand{\caveat}[1]{\marginnote{\textsc{Where we stand:}\\  #1}}

% Prints an epigraph and speaker in sans serif, all-caps type.
\newcommand{\openepigraph}[2]{%
  %\sffamily\fontsize{14}{16}\selectfont
  \begin{fullwidth}
  \sffamily\large
  \begin{doublespace}
  \noindent\allcaps{#1}\\% epigraph
  \noindent \Large \allcaps{#2}% author
  \end{doublespace}
  \end{fullwidth}
}

\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}

\newcommand{\bA}{\mathbf{A}}
\newcommand{\bB}{\mathbf{B}}
\newcommand{\bE}{\mathbf{E}}
\newcommand{\bF}{\mathbf{F}}
\newcommand{\bJ}{\mathbf{J}}

\newcommand{\bb}{\mathbf{b}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\bq}{\mathbf{q}}
\newcommand{\br}{\mathbf{r}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bv}{\mathbf{v}}
\newcommand{\bw}{\mathbf{w}}
\newcommand{\bx}{\mathbf{x}}
\newcommand{\by}{\mathbf{y}}

\newcommand{\CC}{\mathbb{C}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\X}{\times}  % for nonzero entries in matrices
\newcommand{\redX}{{\color{red} \bm{\underline{\X}}}}
\newcommand{\blueX}{{\color{blue} \bm{\underline{\X}}}}

\newcommand{\XX}{$\bm{\times}$}  % for ticks in tables
\newcommand{\gX}{{\color{Gray} $\times$}}

\newcommand{\eps}{\epsilon}
\newcommand{\lam}{\lambda}
\newcommand{\lap}{\triangle}

\newcommand{\Div}{\ensuremath{\nabla\cdot}}
\newcommand{\Curl}{\ensuremath{\nabla\times}}
\newcommand{\grad}{\nabla}

\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}

\newcommand{\cond}{\operatorname{cond}}
\newcommand{\onull}{\operatorname{null}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\range}{\operatorname{range}}
\newcommand{\Span}{\operatorname{span}}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

\newcommand{\Th}{\mathcal{T}_h}
\newcommand{\Pone}{\mathbf{P}_1}

\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\Triangle}{\textsc{triangle}\xspace}
\newcommand{\MPI}{\textsc{MPI}\xspace}

\newcommand{\PETSc}{\textsc{PETSc}\xspace}

\newcommand{\pDM}{\texttt{DM}\xspace}

\newcommand{\pDMDA}{\texttt{DMDA}\xspace}
\newcommand{\pDMPlex}{\texttt{DMPlex}\xspace}
\newcommand{\pKSP}{\texttt{KSP}\xspace}
\newcommand{\pMat}{\texttt{Mat}\xspace}
\newcommand{\pSNES}{\texttt{SNES}\xspace}
\newcommand{\pTS}{\texttt{TS}\xspace}
\newcommand{\pVec}{\texttt{Vec}\xspace}
\newcommand{\pVecs}{\texttt{Vec}s\xspace}

%\renewcommand\floatpagefraction{.9}  %???

% eventually this is a good idea:
%\usepackage{makeidx}
%\makeindex

\begin{document}

% epigraph page first
\newpage\thispagestyle{empty}
\openepigraph{%
\dots when there are disputes among persons, we can simply say: Let us calculate, without further ado, to see who is right.
}{Gottfried Wilhelm Leibniz}
\vfill
\openepigraph{%
Developing parallel, nontrivial PDE solvers that deliver high performance is still difficult and requires months (or even years) of concentrated effort.  PETSc is a toolkit that can ease these difficulties and reduce the development time, but it is not a black-box PDE solver, nor a silver bullet
}{Barry Smith}
\vfill
\openepigraph{%
Tufte's style is known for its extensive use of sidenotes, tight integration of graphics with text, and well-set typography.
}{The Tufte-LaTeX\ Developers}
\vfill

\frontmatter

\maketitle

% v.4 copyright page
\newpage
\begin{fullwidth}
~\vfill
\thispagestyle{empty}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}
Copyright \copyright\ \the\year\ \thanklessauthor

\par\smallcaps{Published by \thanklesspublisher}

%\par I have no idea if I should license this at this stage

\par\textit{First printing, \monthyear}
\end{fullwidth}

\tableofcontents

\begin{comment}
% dedication
\cleardoublepage
~\vfill
\begin{doublespace}
\noindent\fontsize{18}{22}\selectfont\itshape
\nohyphenation
Thanks to \mbox{Jed Brown} and \mbox{Constantine Khroulev}, fellow students, and gurus.
\end{doublespace}
\vfill
\end{comment}

%%%%%%%%%%

\chapter{Why this book?}


You've taken a mathematics course or two in partial differential equations (PDEs).  Somewhere you picked up a bit of coding in C; perhaps you write C code every day.\sidenote{You know that ``API'' stands for ``application program interface,'' for example.}  You've also written various short scripts in \Matlab or python, and you've even tried solving PDEs numerically.  But \emph{now you want it all in parallel on big problems}.  This book is for you and me.

\section{\PETSc?}

The Portable, Extensible Toolkit for Scientific computing (\PETSc\sidenote{Say it ``pets sea.''}) \citep{petsc-user-ref} is an open-source, mathematical software library built on top of the standard software layer for large-scale parallel computation, the Message Passing Interface (MPI) \citep{Groppetal1999}.  Thus \PETSc is a framework for solving problems like PDS at ``large scale,'' that is, at high resolution and on supercomputers with hundreds to millions of cores.

\PETSc is not particularly new.  Version 2.0, the first version to make an impact in the scientific computing world, was built in 1994.  A well-known textbook \citet{Smithetal1996}\sidenote{B.~Smith, P.~Bjorstad, and W.~Gropp. \emph{Domain decomposition: parallel multilevel methods for elliptic partial differential equations}. Cambridge
University Press, 1996} uses \PETSc 2.0 for scalable solutions of linear partial differential equations (PDEs).  That book focusses on pre-conditioned iterative linear solvers.  For example, domain decomposition methods like additive Schwarz are shown to scalably solve the Poisson equation on irregular domains and fine meshes in parallel.

But \PETSc is now at version 3.5.\sidenote{Version 3.5.2 is current in September 2014.  The stable homepage URL for PETSc, including download and installation instructions, is at \href{http://www.mcs.anl.gov/petsc/index.html}{www.mcs.anl.gov/petsc}.}  It has evolved into a more powerful toolbox with a much richer API.

Typical examples and applications now solve nonlinear PDEs at scale.  The \PETSc strategy is to compose Newton's method and mesh topology tools with a run-time chooseable selection of preconditioners and iterative linear solvers.  The nonlinear and multilevel-related parts of the \PETSc API are now highly-visible to users of \PETSc 3.5.  ``Multiphysics problems''\sidenote{This buzzword just refers to a diverse system of coupled PDEs with nontrivial scalings among the variables.  But that is a concept that \emph{needs} a buzzword.} are now within reach.  \PETSc may not be a silver bullet, but users see powerful tools, beyond linear algebra, to solve hard problems.

On the other hand, \PETSc is notoriously complicated.  Twenty years have passed since \PETSc version 2.0.  Perhaps a new book is needed.

\section{The goals of this book}

This book is about approximately solving linear and nonlinear PDEs in 2 or 3 spatial variables by writing C code that calls \PETSc methods.  It tries to both explain the ideas directly, and illustrate them through example codes.  The example codes come with enough background information so that readers can use them as a basis for further developments.  Demonstrated scalability of these examples is the goal, so runtime options are explained and compared.

This book does not replace the \PETSc \emph{User's Manual}.  Indeed, the current book assumes you want to solve PDEs, while there are many other uses of \PETSc.

This book is written from the conviction that better access to common knowledge among experts advances scientific computing as a discipline.  In fact, accessing common knowledge advances the discipline faster than does original research among the experts.  Said another way, I hope that an expert in \PETSc will say about this book's content that ``I knew all that'' \emph{and} that ``this book is a fast on-ramp to what I already know.''

\section{What I need from you, the reader}

To make sense of this book, some of the mathematical theory\sidenote{\citep{Evans} is recommended, but not really a prerequisite.} of PDEs must be familiar.  I will also assume some nebulous, and hard to define, practical intuition about PDE problems, including exposure to nonlinear ones.\sidenote{\citep{Ockendonetal2003} is recommended.}  Of course, all applied mathematicians, distinctly including this author, are wanting when it comes to injesting the mathematical theory of, and building intuition for, nonlinear PDEs.

Multiple numerical discretization paradigms for PDEs will arise in this book.  At least one such numerical approach to PDEs should be in the reader's toolbox.  This background might be based on the finite element method (FEM) \citep{Braess,Elmanetal2005}, finite differences \citep{MortonMayers}, finite volumes \citep{LeVeque}, or spectral methods \citep{KarniadakisSherwin,Trefethen}.  Exposure to multigrid ideas \citep{Briggsetal2000} would be helpful, but these concepts will be reviewed.  Numerical ideas from linear algebra \citep{Greenbaum1997,TrefethenBau} will also appear, often with only a brief introduction.

Starting in Chapter 3 I will assume that you are at least a bit interested in applying the finite element method (FEM) on unstructured grids, though not at the exclusion of structured approaches.  The basics of the FEM method will be reviewed, but the reader must also bring some background understanding of this nontrivial topic.  Perhaps the weak form of a PDE, and the idea of assembling the systems of equations element-by-element, are ``rusty'' topics.  But these topics should be in there somewhere.

Searching in the \PETSc HTML manual pages should be the reader's first resort for resolving compile-time errors, or for exposing the \PETSc API.  However, the reader should also see which topics are addressed in the \PETSc \emph{Users Manual}.  That \emph{Manual} often explains why the API is designed in the way it is.


\section{There is much that this book does NOT do}

Here is a partial list:\begin{itemize}
\item This book does not help you install \PETSc.
\item This book does not replace \citep{Smithetal1996}.
\item This book does not do anything in Fortran.
\item This book does not help with most packages \PETSc links to.
\item This book does not do a complete job of teaching the finite element method.
\item This book does not solve any hyperbolic PDE problems.
\item This book does not consider spatial dimensions except 2 and 3.
\item This book does not prove anything.\sidenote{We do give evidence for convergence and scalability when possible.}
\item This book does not care whether its numerical solutions are good models of physical problems.
\item This book does not adequately cover what is known about nonlinear PDEs, much less what is not known.
\end{itemize}


\mainmatter

%%%%%%%%%

\input{getstarted.tex} % chapter 1

%%%%%%%%%%

\input{structured.tex} % chapter 2

%%%%%%%%%%

\input{unstructured.tex} % chapter 3

%%%%%%%%%%

\input{multigrid.tex} % chapter 4

%%%%%%%%%%

\input{scaling.tex} % chapter 5

%%%%%%%%%%

\chapter{6. Nonlinear elliptic PDEs on structured grids}

\section{Newton's method}

\section{\textsc{SNES}}
% c4newton.c

\section{Example: a porous medium equation}

\section{Jacobians: actual and approximate}

\caveat{But it isn't scaling well yet.}


%%%%%%%%%%

\chapter{7. More run-time preconditioner composition}

\section{Indeterminant systems: Stokes}

\section{More preconditioners}

\caveat{But \PETSc should help with unstructured meshes too.}


%%%%%%%%%%

\chapter{8. Unstructured grids, the right way}

\section{\textsc{DMPlex}}

\caveat{But my PDE isn't really a PDE.  It has an inequality in it.}

%\caveat{But my PDE has ``$t$'' in it.}
%\chapter{7. Time-evolving problems}
%\section{\textsc{TS}}


%%%%%%%%%%

\chapter{9. PDEs with constraints}

\section{A variational inequality problem}


%%%%%%%%%%

\backmatter

\bibliography{book}
\bibliographystyle{plainnat}

\clearpage

\newcommand{\tblockeqncode}[3]{
\begin{tabular}[t]{l} #1: \\ \qquad {\small #2} \\ \quad {\large \underline{\texttt{#3}}} \end{tabular}
}
\newcommand{\tblockcode}[2]{
\begin{tabular}[t]{l} #1 \\ \quad {\large \underline{\texttt{#2}}} \end{tabular}
}
\newcommand{\tblock}[1]{
\begin{tabular}[t]{l} #1 \end{tabular}
}

\thispagestyle{empty}
\noindent \textsc{inside front cover:}

\vfill
\begin{center}
\hspace{-10mm}\begin{tabular}{rllll}
\toprule
Chapter 
    &\quad linear\quad
          &linear
                &\quad nonlinear\quad
                      &nonlinear \\ 
    &     &time-dependent
                &     &time-dependent \\
\midrule  \bigskip
1   &     &     &     &      \\ \bigskip
2   & \tblockeqncode{Poisson}{$-\grad^2 u = f$}{c2poisson.c}
          & \tblockeqncode{heat}{$u_t = \grad^2 u$}{c2heat.c}
                &     &      \\ \bigskip
3   & \tblockcode{Poisson}{c3poisson.c}
          &     &     &      \\ \bigskip
4   & \begin{minipage}[t]{35mm}
 \tblockcode{Poisson}{c4poisson.c}

 \tblockeqncode{advection-diffusion}{$\bv \cdot \grad u - \grad^2 u = f$}{c4ad.c}
\end{minipage}
          &     &     &      \\ \bigskip
5   &     &     &     &      \\ \bigskip
6   &     &     & \tblockeqncode{$p$-Laplace}{$\begin{matrix} -\Div\left(D \grad u\right) = f \\ D = |\grad u|^{p-2} \end{matrix}$}{c6plap.c}
                      & \tblockeqncode{porous}{$\begin{matrix} u_t = \Div\left(D \grad u\right) \\ D = u^{\gamma-1} \end{matrix}$}{c6porous.c} \\ \bigskip
7   & \tblockeqncode{Stokes}{$\begin{matrix} \Div u = 0 \\ \grad p = \grad^2 u \end{matrix}$}{c7stokes.c}
          &     &     &      \\ \bigskip
8   & \tblockcode{Poisson}{c8poisson.c}
          &     &     &      \\
    & \tblockcode{Stokes}{c8stokes.c}
          &     &     &      \\ \bigskip
9   &     &     & \tblockeqncode{obstacle}{$\begin{matrix} -\grad^2 u = f \\ u\ge \psi \end{matrix}$}{c9obstacle.c}
                      & \tblockeqncode{ice sheet}{$\begin{matrix} H_t = \Div\left(D \grad H\right) + f \\ D = H^{n+2} |\grad (H-b)|^{n-1} \\ H \ge 0\end{matrix}$}{c9ice.c} \\
\bottomrule
\end{tabular}
\end{center}
\vfill


\newpage\thispagestyle{empty}
\noindent \textsc{inside back cover:}

\vfill
\begin{center}
\begin{tabular}{rccccccc}
\toprule
Chapter 
    &\;\pVec\; &\;\pMat\;
                &\;\pKSP\; &\pDMDA
                            &\pDMPlex
                                  &\pSNES &\;\pTS\; \\
\midrule
1   & \XX & \XX & \XX &     &     &     &      \\
2   & \XX & \XX & \XX & \XX &     &     & \XX  \\
3   & \XX & \XX & \XX &     &     &     &      \\
4   & \gX & \gX & \XX & \XX &     &     &      \\
5   & \gX & \gX & \XX & \XX &     &     &      \\
6   & \gX & \gX & \XX & \XX &     & \XX & \XX  \\
7   & \gX & \gX & \gX & \XX &     & \XX &      \\
8   & \gX & \gX & \XX &     & \XX & \XX &      \\
9   & \gX & \gX & \gX & \XX &     & \XX &      \\
\bottomrule
\end{tabular}
\end{center}
\vfill

\end{document}
