\documentclass{tufte-book}

\hypersetup{colorlinks}

\usepackage{xspace}
\newcommand{\PETSCVERSION}{3.6\xspace}
\newcommand{\PETSCMINORVERSION}{3.6.1\xspace}
\newcommand{\PETSCMONTH}{September 2015\xspace}

\newcommand{\CODELOC}{}  % each Chapter redefines this

\let\STUBSONLY\relax  %                                <--- UNCOMMENT TO GENERATE STUB CHAPTERS
\ifx\STUBSONLY\undefined
  \newcommand{\stubinput}[2]{\input{#1}}
\else
  \newcommand{\stubinput}[2]{\vspace{5cm} \centerline{\LARGE Percent completed:  \Huge #2\%.} \vfill}
\fi

\renewcommand{\maketitlepage}[0]{%
  \cleardoublepage%
  {%
  \sffamily%
  \begin{fullwidth}%
  \fontsize{18}{20}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{\thanklessauthor}}%
  \vspace{9pc}%
  \fontsize{32}{40}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{\thanklesstitle}}%
  \vfill%
    \fontsize{18}{40}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{numerical solutions in C using}}%
    \fontsize{18}{40}\selectfont\par\noindent\textcolor{darkgray}{\allcaps{the Portable, Extensible Toolkit for Scientific computation version \PETSCVERSION}}%
  \vfill%
  \fontsize{14}{16}\selectfont\par\noindent\allcaps{\thanklesspublisher}%
  \end{fullwidth}%
  }
  \thispagestyle{empty}%
  \clearpage%
}

\title[PETSc for PDEs]{PETSc \\ for \\ Partial \\ Differential \\ Equations}

\author{Ed Bueler}
\publisher{Maybe Someday a Publisher of This Book}

\date{\today}

\usepackage{booktabs} % for nicely-typeset tabular material
\usepackage{verbatim} % for "comment" environment
\usepackage{fancyvrb}
%\usepackage{underscore} % causes "Missing \endcsname inserted" error?
\usepackage{graphicx}
\usepackage{amsmath,amssymb,amsthm,bm}
\usepackage{tikz}

\usetikzlibrary{arrows,decorations.markings,decorations.pathreplacing,fadings}

\usepackage{newfloat,caption}

% macros

\newtheorem*{theorem}{Theorem}
\theoremstyle{definition}
\newtheorem*{example}{Example}
\newtheorem*{examplecont}{Example, continued}

\newcommand{\trueinput}[2]{
\VerbatimInput[frame=single,framesep=3mm,label=\fbox{\normalsize \textsl{\,#1\,}},fontfamily=courier,fontsize=\footnotesize]{#2}
}

% the goal here is to have a display of code with a separate "Code x.y" numbering
% and with the caption in the margin
\DeclareFloatingEnvironment[placement={!ht},name=Code]{mycodeenv}
\captionsetup[mycodeenv]{labelfont=bf}
% next line duplicates declaration of environment "marginfigure" in tufte-common.def
\newenvironment{margincode}[1][-1.2ex]%
  {\begin{@tufte@margin@float}[#1]{mycodeenv}}
  {\end{@tufte@margin@float}}

%\inputfromline{FULLPATH}{FILENAME}{CAPTION}{FIRSTLINE}{LABEL}
\newcommand{\inputfromline}[5]{
\vspace{0.8cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}},%
               fontfamily=courier,%
               fontsize=\footnotesize,%
               firstline=#4]{#1}
\end{minipage}
\vspace{0.5cm}
\begin{margincode}[1.0cm]
\caption{#3}
\label{#5}
\end{margincode}
\vspace{1.5cm}
}

\newcommand{\inputwhole}[4]{\inputfromline{#1}{#2}{#3}{1}{#4}}

%\cinputraw{FULLPATH}{FILENAMESHOWN}{CAPTION}{PARTSTRING}{STARTSTRING}{STOPSTRING}{LABEL}
\newcommand{\cinputraw}[7]{
\newcommand*\FancyVerbStartString{#5}
\newcommand*\FancyVerbStopString{#6}
\vspace{0.8cm}
\begin{minipage}[l]{1.25\textwidth}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\small \textsl{\,#2\,}#4},%
               fontfamily=courier,%
               fontsize=\footnotesize]{#1}
\end{minipage}
\vspace{0.5cm}
\begin{margincode}[1.0cm]
\caption{#3}
\label{#7}
\end{margincode}
\vspace{1.5cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
}

\newcommand{\cinput}[6]{%
    \cinputraw{cstrip/#1}{#2#1}{#3}{}{#4}{#5}{#6}}

\newcommand{\cinputpart}[7]{%
    \cinputraw{cstrip/#1}{#2#1}{#3}{\quad \textbf{part #4}}{#5}{#6}{#7}}

\newcommand{\cinputpartnostrip}[7]{%
    \cinputraw{#1}{#2}{#3}{\quad \textbf{part #4}}{#5}{#6}{#7}}

% Prints an epigraph and speaker in sans serif, all-caps type.
\newcommand{\openepigraph}[2]{%
  %\sffamily\fontsize{14}{16}\selectfont
  \begin{fullwidth}
  \sffamily\large
  \begin{doublespace}
  \noindent\allcaps{#1}\\% epigraph
  \noindent \Large \allcaps{#2}% author
  \end{doublespace}
  \end{fullwidth}
}

\DefineVerbatimEnvironment{code}{Verbatim}
{fontsize=\small,frame=lines,framerule=0.2mm,framesep=2.0mm,xleftmargin=5mm}

\DefineVerbatimEnvironment{cline}{Verbatim}
{fontsize=\small,frame=leftline,framerule=0.3mm,framesep=2.0mm}

\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}

\newcommand{\bA}{\mathbf{A}}
\newcommand{\bB}{\mathbf{B}}
\newcommand{\bE}{\mathbf{E}}
\newcommand{\bF}{\mathbf{F}}
\newcommand{\bJ}{\mathbf{J}}

\newcommand{\bb}{\mathbf{b}}
\newcommand{\bc}{\mathbf{c}}
\newcommand{\be}{\mathbf{e}}
\newcommand{\bbf}{\mathbf{f}} % \bf already defined
\newcommand{\bg}{\mathbf{g}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\bp}{\mathbf{p}}
\newcommand{\bq}{\mathbf{q}}
\newcommand{\br}{\mathbf{r}}
\newcommand{\bs}{\mathbf{s}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bv}{\mathbf{v}}
\newcommand{\bw}{\mathbf{w}}
\newcommand{\bx}{\mathbf{x}}
\newcommand{\by}{\mathbf{y}}
\newcommand{\bz}{\mathbf{z}}

\newcommand{\CC}{\mathbb{C}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\X}{\times}  % for nonzero entries in matrices
\newcommand{\redX}{{\color{red} \bm{\underline{\X}}}}
\newcommand{\blueX}{{\color{blue} \bm{\underline{\X}}}}

\newcommand{\XX}{$\bm{\times}$}  % for ticks in tables
\newcommand{\gX}{{\color{Gray} $\times$}}

\newcommand{\eps}{\epsilon}
\newcommand{\lam}{\lambda}
\newcommand{\lap}{\triangle}

\newcommand{\Div}{\ensuremath{\nabla\cdot}}
\newcommand{\Curl}{\ensuremath{\nabla\times}}
\newcommand{\grad}{\nabla}

\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}

% iteration vec display in R^2
\newcommand{\twovect}[4]{\ensuremath{{#1}_{#2} =
                            \begin{bmatrix} #3 \\ #4 \end{bmatrix}}}
\newcommand{\rvect}[3]{\twovect{\bu}{#1}{#2}{#3}}

\newcommand{\cond}{\operatorname{cond}}
\newcommand{\onull}{\operatorname{null}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\range}{\operatorname{range}}
\newcommand{\Span}{\operatorname{span}}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

\newcommand{\Th}{\mathcal{T}_h}
\newcommand{\Pone}{\mathbf{P}_1}

\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\Triangle}{\textsc{triangle}\xspace}
\newcommand{\MPI}{\textsc{MPI}\xspace}

\newcommand{\PETSc}{\textsc{PETSc}\xspace}

\newcommand{\pDM}{\texttt{DM}\xspace}
\newcommand{\pDMDA}{\texttt{DMDA}\xspace}
\newcommand{\pDMPlex}{\texttt{DMPlex}\xspace}

\newcommand{\pKSP}{\texttt{KSP}\xspace}
\newcommand{\pPC}{\texttt{PC}\xspace}
\newcommand{\pSNES}{\texttt{SNES}\xspace}
\newcommand{\pTS}{\texttt{TS}\xspace}

\newcommand{\pMat}{\texttt{Mat}\xspace}
\newcommand{\pMats}{\texttt{Mat}s\xspace}

\newcommand{\pVec}{\texttt{Vec}\xspace}
\newcommand{\pVecs}{\texttt{Vec}s\xspace}

\setcounter{secnumdepth}{0}

% eventually this is a good idea:
%\usepackage{makeidx}
%\makeindex

\begin{document}

\begin{comment}
% epigraph page first
\newpage\thispagestyle{empty}
\openepigraph{%
\dots when there are disputes among persons, we can simply say: Let us calculate, without further ado, to see who is right.
}{Gottfried Wilhelm Leibniz}
\vfill
\openepigraph{%
Developing parallel, nontrivial PDE solvers that deliver high performance is still difficult and requires months (or even years) of concentrated effort.  PETSc is a toolkit that can ease these difficulties and reduce the development time, but it is not a black-box PDE solver, nor a silver bullet
}{Barry Smith}
\vfill
\openepigraph{%
Tufte's style is known for its extensive use of sidenotes, tight integration of graphics with text, and well-set typography.
}{The Tufte-LaTeX\ Developers}
\vfill

\frontmatter
\end{comment}

\maketitle


\newpage
\begin{fullwidth}
~\vfill
\thispagestyle{empty}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}
Copyright \copyright\ \the\year\ \thanklessauthor

\par\smallcaps{Published by \thanklesspublisher}

%\par  [license here] I have no idea if I should license this at this stage

\par\textit{First printing, \monthyear}
\end{fullwidth}

\tableofcontents


% Thanks to \mbox{Jed Brown} and \mbox{Constantine Khroulev}, fellow students, and gurus.


\chapter*{Preface}
\input{preface.tex}

\mainmatter

%\setcounter{chapter}{0}

\chapter{Getting started with PETSc}
\label{chap:gs}
\renewcommand{\CODELOC}{ch1/}
\input{getstarted.tex}

\chapter{Finite-dimensional linear systems}
\label{chap:ls}
\renewcommand{\CODELOC}{ch2/}
\input{linearsystem.tex}

\chapter{Poisson PDE on a structured grid}
\label{chap:st}
\renewcommand{\CODELOC}{ch3/}
\input{structured.tex}

\chapter{Nonlinear equations}
\label{chap:nl}
\renewcommand{\CODELOC}{ch4/}
\input{nonlinear.tex}

\chapter{Nonlinear optimization, and a finite element method}
\label{chap:of}
\renewcommand{\CODELOC}{ch5/}
\stubinput{optifem.tex}{10}

\chapter{Multigrid}
\label{chap:mg}
\renewcommand{\CODELOC}{ch6/}
\stubinput{multigrid.tex}{20}

\chapter{Parallel scaling and performance}
\label{chap:sc}
\renewcommand{\CODELOC}{ch7/}
\stubinput{scaling.tex}{5}

\chapter{An unstructured finite element method}
\label{chap:un}
\renewcommand{\CODELOC}{ch8/}
\stubinput{unstructured.tex}{40}

\chapter{Systems of PDEs, and the Stokes equations}
\label{chap:sy}
\renewcommand{\CODELOC}{ch9/}
\stubinput{stokes.tex}{5}

\chapter{Unstructured grids, the right way}
\label{chap:dp}
\renewcommand{\CODELOC}{ch10/}
\stubinput{dmplex.tex}{0}

\chapter{PDEs with constraints}
\label{chap:co}
\renewcommand{\CODELOC}{ch11/}
\stubinput{constrained.tex}{20}

%%%%%%%%%%

\backmatter

\bibliography{book}
\bibliographystyle{plainnat}

\clearpage

\newcommand{\tblockeqncode}[3]{
\begin{tabular}[t]{l} #1 \\ \quad {\normalsize \texttt{#3}} \\ \qquad \fbox{\small #2} \end{tabular}
}
\newcommand{\tblockcode}[2]{
\begin{tabular}[t]{l} #1 \\ \quad {\normalsize \texttt{#2}} \end{tabular}
}
\newcommand{\tblock}[1]{
\begin{tabular}[t]{l} #1 \end{tabular}
}

\clearpage
\thispagestyle{empty}
\noindent \textsc{inside front cover:}

\vfill
{\large \noindent \textsc{PDE examples}.} \quad Chapter $N$ codes are in directory \texttt{c/ch}$N$\texttt{/}.

\begin{center}
\small
\hspace{-10mm}\begin{tabular}{lllll}
\toprule
Chap.
    &linear
          &nonlinear
                &nonlinear time-dependent \\
\midrule  \bigskip
\ref{chap:st}
    & \tblockeqncode{Poisson (2D)}{$-\grad^2 u = f$}{poisson.c}
          &     &      \\ \bigskip
\ref{chap:nl}
    &     & \tblockeqncode{diffusion-reaction (1D)}{$- u''-R(u)=f$}{reaction.c} &      \\ \bigskip
\ref{chap:of}
    &     & \tblockeqncode{$p$-Laplace (2D)}{$\begin{matrix} -\Div\left(D \grad u\right) = f \\ D = |\grad u|^{p-2} \end{matrix}$}{plap.c}
                      &  \\ \bigskip
\ref{chap:mg}
    & \begin{minipage}[t]{35mm}
 \tblockcode{Poisson (2D, 3D)}{fish2.c, fish3.c}

 \tblockeqncode{advection-diffusion (2D)}{$\bv \cdot \grad u - \grad^2 u = f$}{ad.c}
\end{minipage}
          &     &      \\ \bigskip
\ref{chap:sc}
    & \tblockeqncode{time-dependent heat (2D)}{$u_t = \grad^2 u$}{heat.c}
          &     & \tblockeqncode{porous (3D)}{$\begin{matrix} u_t = \Div\left(D \grad u\right) \\ D = u^{\gamma-1} \end{matrix}$}{porous.c} \\ \bigskip
\ref{chap:un}
    & \tblockcode{Poisson (2D)}{unfish.c}    &     &     &      \\ \bigskip
\ref{chap:sy}
    & \tblockeqncode{Stokes (2D)}{$\begin{matrix} -\grad^2 \bu + \grad p = 0 \\ \Div \bu = 0 \end{matrix}$}{stokes.c}
          &     & \tblockeqncode{shallow water (1D)}{$\begin{matrix} h_t + (hv)_x = 0 \\ (hv)_t + (hv^2 + \tfrac{1}{2} g h^2)_x = 0 \end{matrix}$}{water.c}     \\ \bigskip
\ref{chap:dp}
    & \tblockcode{Poisson (2D, 3D)}{plexfish.c}
          &     &      \\ \bigskip
\ref{chap:co}
    &     & \tblockeqncode{obstacle}{$\begin{matrix} -\grad^2 u = f \\ u\ge \psi \end{matrix}$}{obstacle.c}
                & \tblockeqncode{ice sheet}{$\begin{matrix} H_t = \Div\left(D \grad H\right) + f \\ D \text{ nonlinear},\, H \ge 0\end{matrix}$}{ice.c} \\
\bottomrule
\end{tabular}
\end{center}
\vfill


\newpage\thispagestyle{empty}
\noindent \textsc{inside back cover:}

\vfill
{\large \noindent \textsc{\PETSc component coverage}}

\begin{center}
\begin{tabular}{rccccccc}
\toprule
Chapter 
    &\;\pVec\;
          &\;\pMat\;
                &\;\texttt{KSP}${+}$\pPC\;
                      &\pSNES
                            &\pDMPlex
                                  &\pDMDA
                                        &\;\pTS\; \\
\midrule
2   & \XX & \XX & \XX &     &     &     &      \\
3   & \XX & \XX & \XX &     &     & \XX &      \\
4   & \gX & \XX & \gX & \XX &     & \XX &      \\
5   & \gX & \gX & \gX & \XX &     & \XX &      \\
6   & \gX & \gX & \XX & \XX &     & \XX &      \\
7   & \gX & \gX & \XX & \XX &     & \XX & \XX  \\
8   & \XX & \XX & \gX & \XX &     &     & \XX  \\
9   & \gX & \gX & \XX & \XX &     & \XX &      \\
10  & \gX & \gX & \XX & \XX & \XX &     &      \\
11  & \gX & \gX & \gX & \XX &     & \XX &      \\
\bottomrule
\end{tabular}
\end{center}
\vfill

\end{document}
