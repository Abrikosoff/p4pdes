\documentclass{tufte-book}

\hypersetup{colorlinks}

\title{PETSc \\ for \\ Partial \\ Differential \\ Equations}
\author{Ed Bueler}
\publisher{Maybe Someday a Publisher of This Book}

\date{\today}

\usepackage{booktabs} % for nicely-typeset tabular material
\usepackage{verbatim} % for "comment" environment
\usepackage{xspace}
\usepackage{fancyvrb}
\usepackage{graphicx}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{tikz}
\usetikzlibrary{arrows,decorations.markings}

\usepackage[subtle,floats]{savetrees}

% macros

\theoremstyle{definition}
\newtheorem*{example}{{\color{cyan} Example}}

\newcommand{\trueinput}[2]{
\VerbatimInput[frame=single,framesep=3mm,label=\fbox{\normalsize \textsl{\,#1\,}},fontfamily=courier,fontsize=\footnotesize]{#2}
}

%\inputfromline{FULLPATH}{FILENAME}{CAPTION}{FIRSTLINE}{LABEL}
\newcommand{\inputfromline}[5]{
\begin{figure*}
\vspace{0.8cm}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\normalsize \textsl{\,#2\,}},%
               fontfamily=courier,%
               fontsize=\small,%
               firstline=#4]{#1}
\vspace{0.5cm}
\caption{#3}
\label{#5}
\end{figure*}
}

\newcommand{\inputwhole}[4]{\inputfromline{#1}{#2}{#3}{1}{#4}}

%\cinputraw{FULLPATH}{FILENAME}{CAPTION}{PARTSTRING}{STARTSTRING}{STOPSTRING}{LABEL}
\newcommand{\cinputraw}[7]{
\newcommand*\FancyVerbStartString{#5}
\newcommand*\FancyVerbStopString{#6}
\begin{figure*}
\vspace{0.8cm}
\VerbatimInput[frame=single,%
               framesep=3mm,%
               label=\fbox{\normalsize \textsl{\,#2\,}#4},%
               fontfamily=courier,%
               fontsize=\small]{#1}
\vspace{0.5cm}
\caption{#3}
\label{#7}
\end{figure*}
\let\FancyVerbStartString\relax
\let\FancyVerbStopString\relax
}

\newcommand{\cinput}[5]{%
    \cinputraw{cstrip/#1}{#1}{#2}{}{#3}{#4}{#5}}
\newcommand{\cinputnostrip}[5]{%
    \cinputraw{../c/#1}{#1}{#2}{}{#3}{#4}{#5}}

\newcommand{\cinputpart}[6]{%
    \cinputraw{cstrip/#1}{#1}{#2}{\quad \textbf{part #3}}{#4}{#5}{#6}}
\newcommand{\cinputpartnostrip}[6]{%
    \cinputraw{../c/#1}{#1}{#2}{\quad \textbf{part #3}}{#4}{#5}{#6}}

\newcommand{\caveat}[1]{\marginnote{\textsc{Where we stand:}\\  #1}}

% Prints an epigraph and speaker in sans serif, all-caps type.
\newcommand{\openepigraph}[2]{%
  %\sffamily\fontsize{14}{16}\selectfont
  \begin{fullwidth}
  \sffamily\large
  \begin{doublespace}
  \noindent\allcaps{#1}\\% epigraph
  \noindent \Large \allcaps{#2}% author
  \end{doublespace}
  \end{fullwidth}
}

\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}

\newcommand{\bA}{\mathbf{A}}
\newcommand{\bB}{\mathbf{B}}
\newcommand{\bE}{\mathbf{E}}
\newcommand{\bF}{\mathbf{F}}
\newcommand{\bJ}{\mathbf{J}}

\newcommand{\bb}{\mathbf{b}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\br}{\mathbf{r}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bx}{\mathbf{x}}

\newcommand{\CC}{\mathbb{C}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\X}{\times}  % for nonzero entries in matrices
\newcommand{\redX}{{\color{red} \X}}
\newcommand{\blueX}{{\color{blue} \X}}

\newcommand{\eps}{\epsilon}
\newcommand{\lam}{\lambda}
\newcommand{\lap}{\triangle}

\newcommand{\Div}{\ensuremath{\nabla\cdot}}
\newcommand{\Curl}{\ensuremath{\nabla\times}}
\newcommand{\grad}{\nabla}

\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}

\newcommand{\onull}{\operatorname{null}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\range}{\operatorname{range}}
\newcommand{\Span}{\operatorname{span}}

\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

\newcommand{\Th}{\mathcal{T}_h}
\newcommand{\Pone}{\mathbf{P}_1}

\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\PETSc}{\textsc{PETSc}\xspace}
\newcommand{\Triangle}{\textsc{triangle}\xspace}

\newcommand{\pDM}{\texttt{DM}\xspace}
\newcommand{\pDMPlex}{\texttt{DMPlex}\xspace}
\newcommand{\pKSP}{\texttt{KSP}\xspace}
\newcommand{\pMat}{\texttt{Mat}\xspace}
\newcommand{\pSNES}{\texttt{SNES}\xspace}
\newcommand{\pTS}{\texttt{TS}\xspace}
\newcommand{\pVec}{\texttt{Vec}\xspace}

%\renewcommand\floatpagefraction{.9}  %???

% eventually this is a good idea:
%\usepackage{makeidx}
%\makeindex

\begin{document}

\frontmatter

% epigraph page first
\newpage\thispagestyle{empty}
\openepigraph{%
\dots when there are disputes among persons, we can simply say: Let us calculate, without further ado, to see who is right.
}{Gottfried Wilhelm Leibniz}
\vfill
\openepigraph{%
Developing parallel, nontrivial PDE solvers that deliver high performance is still difficult and requires months (or even years) of concentrated effort.  PETSc is a toolkit that can ease these difficulties and reduce the development time, but it is not a black-box PDE solver, nor a silver bullet
}{Barry Smith}
\vfill
\openepigraph{%
Tufte's style is known for its extensive use of sidenotes, tight integration of graphics with text, and well-set typography.
}{The Tufte-LaTeX\ Developers}
\vfill

\maketitle

% v.4 copyright page
\newpage
\begin{fullwidth}
~\vfill
\thispagestyle{empty}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}
Copyright \copyright\ \the\year\ \thanklessauthor

\par\smallcaps{Published by \thanklesspublisher}

%\par I have no idea if I should license this at this stage

\par\textit{First printing, \monthyear}
\end{fullwidth}

\tableofcontents

\begin{comment}
% dedication
\cleardoublepage
~\vfill
\begin{doublespace}
\noindent\fontsize{18}{22}\selectfont\itshape
\nohyphenation
Thanks to \mbox{Jed Brown} and \mbox{Constantine Khroulev}, fellow students, and gurus.
\end{doublespace}
\vfill
\end{comment}

%%%%%%%%%%

\chapter{Why this book?}


You've taken a mathematics course or two in partial differential equations (PDEs).  Somewhere you picked up a bit of coding in C; perhaps you write C code every day.\sidenote{You know that ``API'' stands for ``application program interface,'' for example.}  You've also written various short scripts in \Matlab or python, and you've even tried solving PDEs numerically.  But \emph{now you want it all in parallel on big problems}.  This book is for you and me.

\section{\PETSc?}

The Portable, Extensible Toolkit for Scientific computing (\PETSc\sidenote{Say it ``pets sea.''}) \citep{petsc-user-ref} is a software library built on top of the standard software layer for large-scale parallel computation, the Message Passing Interface (MPI) \citep{Groppetal1999}.

\PETSc is not new software.  Version 2.0, the first to make an impact in the scientific computing world, was built in 1994.  A well-known textbook \citet{Smithetal1996}\sidenote{B.~Smith, P.~Bjorstad, and W.~Gropp. \emph{Domain decomposition: parallel multilevel methods for elliptic partial differential equations}. Cambridge
University Press, 1996} uses \PETSc 2.0 for scalable solutions of linear partial differential equations (PDEs).  Its focus is on pre-conditioned iterative linear solvers.  For example, domain decomposition methods like additive Schwarz are shown to scalably solve the Poisson equation on irregular domains and fine meshes in parallel.

But \PETSc is now at version 3.5,\sidenote{Version 3.5.2 is current in September 2014.  The stable homepage URL for PETSc, including download and installation instructions, is at \href{http://www.mcs.anl.gov/petsc/index.html}{www.mcs.anl.gov/petsc}.} and it has transformed into something better.  Typical examples and applications now emphasize solving nonlinear PDEs at scale.  The 21st-century \PETSc strategy is to compose Newton's method and mesh topology tools---these new parts of the \PETSc API are highly-visible to modern library users---with a run-time chooseable selection of preconditioners and iterative linear solvers.  ``Multiphysics problems''\sidenote{This buzzword just refers to a diverse system of coupled PDEs with nontrivial scalings among the variables.  But that is a concept that \emph{needs} a buzzword.} are now within reach.  \PETSc may not be a silver bullet, but users see powerful tools, beyond linear algebra, to solve hard problems.

On the other hand, \PETSc is notoriously complicated.  So perhaps a new book is needed.

\section{The goals of this book}

This book is about approximately solving nonlinear PDEs by writing C code that calls \PETSc methods.  It tries to both explain the ideas directly, and illustrate them through example codes.  The example codes come with enough background information so that they can be the basis for further developments.  Demonstrated scalability of these examples is the goal, which means runtime options are explained and compared.

This book does not replace the \PETSc \emph{User's Manual}.  For one thing, the current book assumes you want to solve PDEs, while there are many other uses of \PETSc.  The reader should at least know which topics are addressed in the \emph{User's Manual}, even if searching online or in the HTML manual is the first resort for resolving compile-time errors or for exposing the API.

\section{What I need from you, the reader}

Some of the mathematical theory\sidenote{\citep{Evans} is recommended.} of PDEs must be familiar to you, but I will also assume some (nebulous, and hard to define) practical intuition about PDE problems, including exposure to nonlinear ones.\sidenote{\citep{Ockendonetal2003} is recommended.}  Of course, all applied mathematicians, distinctly including this author, are wanting when it comes to absorbing the mathematical theory of, and gaining intuition for, nonlinear PDEs.

Numerical ideas from linear algebra \citep{TrefethenBau} arise in this book, but so will multiple numerical discretization strategies for PDEs.  Thus at least one numerical paradigm for PDEs must be in the reader's toolbox.  This numerical background might be based on finite differences \citep{MortonMayers} or finite volumes \citep{LeVeque}, but I will assume you are interested in applying the finite element method (FEM) on unstructured grids.  The basics of the FEM method will be reviewed, but the reader must bring some background understanding of this nontrivial topic.\sidenote{\citet{Elmanetal2005}, \citet{Braess}, and \citet{KarniadakisSherwin} are all recommended.}  Perhaps the weak form of a PDE, and the idea of assembling the systems of equations element-by-element, are ``rusty'' topics.  But these topics must be there somewhere.

\section{There is much that this book does NOT do}

Here is a partial list:\begin{itemize}
\item This book does not help you install \PETSc.
\item This book does not replace a good online tutorial on getting started in \PETSc.
\item This book does not replace \citep{Smithetal1996}.
\item This book does not do anything in Fortran.
\item This book does not help with most packages \PETSc links to.
\item This book does not do a good job teaching the FEM.
\item This book does not help much if your PDE problem is hyperbolic.
\item This book does not consider spatial dimensions except 2 and 3.
\item This book does not prove anything.\sidenote{We do give evidence for convergence and scalability when possible.}
\item This book does not care whether its numerical solutions are good models of physical problems.
\item This book does not adequately cover what is known about nonlinear PDEs, much less what is not known.
\end{itemize}


\mainmatter

%%%%%%%%%

\input{getstarted.tex} % chapter 1

%%%%%%%%%%

\input{linear.tex} % chapter 2

%%%%%%%%%%

\chapter{3. Nonlinear elliptic PDEs on structured grids}

\section{Newton's method}

\section{\textsc{SNES}}

%\cinput{c3newton.c}{}

\section{Structured grids in \PETSc}

%\cinput{c3poisson.c}{}

\section{Example: a porous medium equation}

%\cinput{c3porous.c}{}

\section{Jacobians: actual and approximate}

\section{Indeterminant systems: Stokes}

%\cinput{c3stokes.c}{}

\caveat{But it isn't scaling well yet.}

%%%%%%%%%%

\chapter{4. Multigrid, and other run-time preconditioner composition}

\section{\textsc{DM}}

\caveat{But \PETSc should help with unstructured meshes too.}

%%%%%%%%%%

\chapter{5. Unstructured grids, the right way}

\section{\textsc{DMPlex}}

%\cinput{c5poisson.c}{}

\caveat{But my PDE has ``$t$'' in it.}

%%%%%%%%%%

\chapter{6. Time-evolving problems}

\section{\textsc{TS}}

%\cinput{c6freesurface.c}{}

\caveat{But my PDE isn't really a PDE.  It has an inequality in it.}

%%%%%%%%%%

\chapter{7. PDEs with constraints}

\section{A variational inequality problem}

%\cinput{c7obstacle.c}{}

%%%%%%%%%%

\backmatter

\bibliography{ice-bib}
\bibliographystyle{plainnat}

\end{document}
