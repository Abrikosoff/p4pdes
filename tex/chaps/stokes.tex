
\section{Equations for incompressible fluids}

Roughly-speaking, a \emph{fluid} is a mathematical abstraction in which the density and the velocity of a mass of particles are given by continuous functions.  We present only enough of the theory of fluids to give an example of solving the Stokes model for slow, very-viscous fluids, and we keep to the constant-density case.  A comprehensive introduction to modeling of fluids, from \citep{Acheson1990} or \citep{Fowler1997} for example, is recommended.

Consider an incompressible fluid with velocity $\bu=\bu(t,x,y,z)$, of constant density $\rho$, with \emph{(dynamic) viscosity} $\mu$, and subject to a \emph{body force} $\rho \bg$ where $\bg$ has units of acceleration.  The incompressible variable-viscosity \emph{Navier-Stokes model} has these main equations
\begin{align}
\rho \left(\frac{\partial \bu}{\partial t} + \bu \cdot \grad \bu\right) &= \Div \sigma + \rho \bg, \label{eq:ok:nsmomentum} \\
\Div \bu &= 0, \label{eq:ok:nsincomp} \\
\sigma &= 2 \mu\, D \bu - p I. \label{eq:ok:nsflowlaw}
\end{align}
Equation \eqref{eq:ok:nsmomentum} is an equation of \emph{momentum conservation} (or \emph{balance}), which is to say a statement of Newton's second law ``$ma=F$,'' and \eqref{eq:ok:nsincomp} states incompressibility.  The \emph{flow law} \eqref{eq:ok:nsflowlaw} relates the stress tensor $\sigma=\sigma_{ij}$ to the \emph{strain rate tensor}, the symmetrized velocity gradient
    $$D \bu = \frac{1}{2} \left(\grad \bu + \grad \bu^{\top}\right).$$
Because of the symmetry of the stress and strain-rate tensors, equations \eqref{eq:ok:nsmomentum}, \eqref{eq:ok:nsincomp}, \eqref{eq:ok:nsflowlaw} represent $3+1+6=10$ scalar equations, respectively.

Our notation has hit a ``subscripting crisis'', so we use a superscript for components of the velocity field, namely $\bu = \left<u^x,u^y,u^z\right>$.  In this notation the spatial derivatives in the above equations are, by definition,
\begin{equation}
\grad \bu = \renewcommand{\arraystretch}{1.3}\begin{bmatrix}
    \frac{\partial u^x}{\partial x} & \frac{\partial u^y}{\partial x} & \frac{\partial u^z}{\partial x} \\
    \frac{\partial u^x}{\partial y} & \frac{\partial u^y}{\partial y} & \frac{\partial u^z}{\partial y} \\
    \frac{\partial u^x}{\partial z} & \frac{\partial u^y}{\partial z} & \frac{\partial u^z}{\partial z}
    \end{bmatrix}, \quad
\Div \bu = \frac{\partial u^x}{\partial x} + \frac{\partial u^y}{\partial y} + \frac{\partial u^z}{\partial z}. \label{eq:ok:graddivudefinition}
\end{equation}

To give some additional physical meaning to equations \eqref{eq:ok:nsmomentum}--\eqref{eq:ok:nsflowlaw}, if we measure distances in meters, mass in kilograms, and time in seconds (``MKS units'') then the quantities which are balanced in \eqref{eq:ok:nsmomentum} are in units $\text{kg}\, \text{m}^{-2}\, \text{s}^{-2}$, namely \emph{stress gradients}.  In fact, noting that the MKS unit of force is the Newton ($\text{N}=\text{kg}\, \text{m}\, \text{s}^{-2}$), the quantities in \eqref{eq:ok:nsmomentum} are forces per unit area, or stress in Pascals ($\text{Pa} = \text{N}\, \text{m}^{-2}$) per meter.  The velocity derivatives $\grad \bu$ and $D\bu$ have units of $\text{s}^{-1}$ and the dynamic viscosity $\mu$ has units $\text{Pa}\, \text{s} = \text{kg}\, \text{m}^{-1}\, \text{s}^{-1}$.

FIXME: theory where Froude $\approx 0$

In the \emph{(variable-viscosity) Stokes model} the body force, the pressure gradient, and the viscous stress gradients are in balance.  This is the model which arises when we set the entire acceleration term on the left side of \eqref{eq:ok:nsmomentum} to zero:
\begin{align}
- \Div \left(\mu \left(\grad \bu + \grad \bu^{\top}\right)\right) + \grad p &= \rho \bg \label{eq:ok:varstokesmomentum} \\
\Div \bu &= 0 \label{eq:ok:varstokesincomp}
\end{align}
A shallow case of these equations will be addressed in Chapter \ref{chap:co}, with a nontrivial model for the variable viscosity $\mu$.

In the current Chapter, however, we consider the case where the viscosity $\mu$ is constant.  In such case the velocity second derivative term is a Laplacian operator (Exercise \ref{chap:ok}.\ref{exer:ok:constantviscositystokes}).  Thus for this Chapter the Stokes equations are
\begin{align}
- \mu \grad^2 \bu + \grad p &= \rho \bg  \label{eq:ok:constantviscositystokes} \\
\Div \bu &= 0  \label{eq:ok:constantviscosityincomp}
\end{align}
This is a Poisson-like problem for $\bu$, but with pressure as an additional unknown and with an additional equation stating incompressiblity.


\section{Weak form of the Stokes equations}

FIXME: theory from \citep{Braess2007,Elmanetal2005}; derive quickly

We assume that the boundary is decomposed disjointly, $\partial\Omega = \partial_D\Omega \cup \partial_N\Omega$, and on these portions we will allow (arbitrary) Dirichlet and Neumann boundary conditions.  The former correspond to having the velocity $\bu$ equal to a known function.  The derivation of the weak form, as follows, establishes the form of the latter.

Suppose $\bu$, $p$ are (classical) solutions to \eqref{eq:ok:constantviscositystokes}, \eqref{eq:ok:constantviscosityincomp}.  Suppose $\bv$, a smooth velocity test function, satisfies $\bv=0$ on $\partial_D\Omega$.  Multiplying \eqref{eq:ok:constantviscositystokes} by $\bv$ and integrating-by-parts---see Exercise \ref{exer:ok:weakderive} for details and notation---we get
\begin{equation}
\int_{\partial_N \Omega} \left[- \mu \frac{\partial \bu}{\partial n} + p \bn \right] \cdot \bv + \int_\Omega \mu \grad \bu : \grad \bv - p \Div \bv = \int_\Omega \rho \bg \cdot \bv. \label{eq:ok:weakstokeswithboundary}
\end{equation}

The quantity in square brackets has units of stress, and we assume it is equal to a known function on the Neumann part of the boundary:
\begin{equation}
\mu \frac{\partial \bu}{\partial n} - p \bn = \bbf_N \quad \text{on } \partial_N \Omega.  \label{eq:ok:neumannbc}
\end{equation}

Define
\begin{equation}
\mathcal{V}_D = \left\{\bw \in W^{1,2}(\Omega)^3 \,\Big|\, \bw = \bbf_D \, \text{ on } \partial_D \Omega\right\}. \label{eq:ok:dirichletbc}
\end{equation}
We say $\bu \in \mathcal{V}_D$ and $p \in L^2(\Omega)$ solve the \emph{weak form of the Stokes equations} if
\begin{align}
\int_\Omega \mu \grad \bu : \grad \bv - p \Div \bv &= \int_\Omega \rho \bg \cdot \bv + \int_{\partial_N \Omega} \bbf_N \cdot \bv \label{eq:ok:weakstokesvelocity} \\
\int_\Omega q \Div \bu &= 0 \label{eq:ok:weakstokespressure}
\end{align}
for all $\bv \in \mathcal{V}_0 = W_0^{1,2}(\Omega)^3$ and $q \in L^2(\Omega)$.


\section{Example I: A small step}

Before constructing an FEM for the differential equations above, building a small, concrete case \emph{by hand} is worthwhile.  This will guide our expectations about the form of the discrete equations; it will help us think.

We consider a ``Poiseuille flow'' \citep{Acheson1990,Elmanetal2005} in 2D on $\Omega=(-1,1)\times(-1,1)$ with constant viscosity $\mu=1$ and no body force $\rho \bg=0$.  The fluid problem we have in mind has an exact, steady solution (Figure \ref{fig:ok:poiseuillesolutions}) where the pressure is, for now, only determined up to a constant:
\begin{equation}
u^x = 1-y^2, \quad u^y=0, \quad p = -2x + C.  \label{eq:ok:poiseuilleexact}
\end{equation}
That is, the strictly horizontal (rightward) flow is driven (balanced) by a pressure gradient which is also horizontal.  On the top and bottom $y=\pm 1$ we have homogeneous Dirichlet boundary conditions $\bu=\left<0,0\right>$.  On the left side $x=-1$ we have Dirichlet inflow boundary conditions $\bu(-1,y) = \left<1-y^2,0\right>$.  On the right side $x=+1$ we choose a Neumann stress-free boundary condition $\partial \bu/\partial n - \bn p = 0$, noting $\bn = \left<1,0\right>$.

\begin{figure}
\input{tikz/poiseuillesolutions.tex}
\caption{In a Poiseuille flow the gradient of the pressure (left; contours of constant pressure) is balanced by viscous shear forces from vertical variation in the velocity (right).}
\label{fig:ok:poiseuillesolutions}
\end{figure}

The small example comes from the tiny grid in Figure \ref{fig:ok:poiseuilletinygrid} with nine nodes and four square elements.  Six of the nodes correspond to homogeneous Dirichlet boundary conditions on the velocity.  The single non-homogeneous Dirichlet boundary condition, at location $(-1,0)$, is incorporated into the solution by the expression
\begin{equation} 
\bu = \left<\psi_{-1}+\alpha_0\psi_0+\alpha_1\psi_1,\beta_0\psi_0+\beta_1\psi_1\right>  \label{eq:ok:smallexpansionvelocity}
\end{equation}
where $\psi_{-1},\psi_0,\psi_1$ denote $Q^1$ hat functions at points $(-1,0),(0,0),(1,0)$, respectively, and $\alpha_0,\alpha_1,\beta_0,\beta_1$ are unknown scalars.  (Because the boundary data is interpolated, the trial function space is only approximately inside the solution space $W_D^{1,2}(\Omega)^2$ for the continuous problem.)

\begin{figure}
\input{tikz/poiseuilletinygrid.tex}
\caption{$\Omega=(-1,1)\times(-1,1)$ for Poiseuille flow, with a very-coarse grid of four elements $\square_k$.  Open circles ``{\large $\circ$}'' are velocity unknowns, ``$\bullet$'' are Dirichlet boundary conditions, and ``$\times$'' are pressure unknowns.}
\label{fig:ok:poiseuilletinygrid}
\end{figure}

The pressure solution is in terms of $P^0$ basis functions, which are characteristic functions on the elements $\one_j = \one_{\square_j}$, so
\begin{equation}
p = \gamma_0 \one_0 + \gamma_1 \one_1 + \gamma_2 \one_2 + \gamma_3 \one_3.  \label{eq:ok:smallexpansionpressure}
\end{equation}

Inserting \eqref{eq:ok:smallexpansionvelocity} and \eqref{eq:ok:smallexpansionpressure} into \eqref{eq:ok:weakstokesvelocity} gives
\begin{align}
&\alpha_0 \int_\Omega \grad \psi_0 \cdot \grad v^x + \beta_0 \int_\Omega \grad \psi_0 \cdot \grad v^y \label{eq:ok:smallconcretevelocity} \\
&\qquad + \alpha_1 \int_\Omega \grad \psi_1 \cdot \grad v^x + \beta_1 \int_\Omega \grad \psi_1 \cdot \grad v^y \notag \\
&\qquad - \gamma_0 \int_{\square_0} \Div \bv - \gamma_1 \int_{\square_1} \Div \bv - \gamma_2 \int_{\square_2} \Div \bv - \gamma_3 \int_{\square_3} \Div \bv \notag \\
&= - \int_\Omega \grad \psi_{-1} \cdot \grad v^x \notag
\end{align}
for test functions $\bv \in W_0^{1,2}(\Omega)^2$.  Inserting \eqref{eq:ok:smallexpansionvelocity} into \eqref{eq:ok:weakstokespressure}, and changing the sign to give symmetry (see below), gives
\begin{align}
&- \alpha_0 \int_\Omega q \frac{\partial \psi_0}{\partial x} - \beta_0 \int_\Omega q \frac{\partial \psi_0}{\partial y} - \alpha_1 \int_\Omega q \frac{\partial \psi_1}{\partial x} - \beta_1 \int_\Omega q \frac{\partial \psi_1}{\partial y}  \label{eq:ok:smallconcretepressure} \\
&= \int_\Omega q \frac{\partial \psi_{-1}}{\partial x} \notag
\end{align}
for test functions $q \in L^2(\Omega)$.

There are eight unknown scalars in system \eqref{eq:ok:smallconcretevelocity}, \eqref{eq:ok:smallconcretepressure}, namely $\alpha_j,\beta_j,\gamma_j$.  We choose velocity test functions from the basis of $Q^1$ hat functions at $(0,0),(1,0)$, so
\begin{equation}
\bv_i \in \left\{\left<\psi_0,0\right>, \left<0,\psi_0\right>, \left<\psi_1,0\right>, \left<0,\psi_1\right>\right\},  \label{eq:ok:smallvelocitytest}
\end{equation}
and pressure test functions from a $P^0$ basis,
\begin{equation}
q_i \in \{\one_0,\one_1,\one_2,\one_3\}.  \label{eq:ok:smallpressuretest}
\end{equation}
By using these in equations \eqref{eq:ok:smallconcretevelocity} and \eqref{eq:ok:smallconcretepressure} we get the following $N=8$ dimensional matrix problem to solve,
\begin{equation}
\begin{bmatrix}
r   &     & t   &     & b_0 & b_1 & b_2 & b_3 \\
    & r   &     & t   & c_0 & c_1 & c_2 & c_3 \\
t   &     & s   &     &     & d_1 &     & d_3 \\
    & t   &     & s   &     & e_1 &     & e_3 \\
b_0 & c_0 &     &     \\
b_1 & c_1 & d_1 & e_1 \\
b_2 & c_2 &     &     \\
b_3 & c_3 & d_3 & e_3
\end{bmatrix} 
\begin{bmatrix}
\alpha_0 \\ \beta_0 \\ \alpha_1 \\ \beta_1 \\ \gamma_0 \\ \gamma_1 \\ \gamma_2 \\ \gamma_3
\end{bmatrix}
=
\begin{bmatrix}
f_0 \\
0 \\
0 \\
0 \\
g_0 \\
0 \\
g_2 \\
0
\end{bmatrix}  \label{eq:ok:smallmatrixproblem}
\end{equation} 
wherein all blank entries are zero.

Exercise \ref{chap:ok}.\ref{exer:ok:smalldetails} computes $r,s,t,b_j,c_j,d_j,e_j,f_0,g_j$.  FIXME

FIXME  I believe this gives a solvable system (sort of by accident)


\section{Example II: A stumble}

FIXME \emph{enclose} with Dirichlet outflow matching inflow; observe compatibility required (\citep{Elmanetal2005} (5.4)) but satisfied; gives $B \in \RR^{4\times 2}$ for which $B^\top$ has two-dimensional null space instead of $\Null(B^\top) = \left<\mathbf{1}\right>$ as it is supposed to; see \citep{Elmanetal2005} (5.47) and (5.64)



\section{Fluid flowing down a slope}

FIXME: reduce to 2D with gravity body force.

The particular problem we will solve is a constant-thickness flow down a slope of angle $\theta$, using rotated coordinates as in Figure \ref{fig:ok:slabonslope}.  First we simplify the appearance of the field equations.  Write $u=u_1$ and $v=u_2$.  Then the three scalar equations are
\begin{align}
-\nu \grad^2 u + p_x &= g_1 \label{eq:ok:stokes2du} \\
-\nu \grad^2 v + p_y &= g_2 \label{eq:ok:stokes2dv} \\
- u_x - v_y &= 0 \label{eq:ok:stokes2dincomp}
\end{align}
where $\nu$ is constant and $\bg = (g_1,g_2) = (\rho g \sin \theta, - \rho g \cos \theta)$.

\begin{marginfigure}
\input{tikz/slabonslope.tex}
\caption{Geometry and boundary conditions of our first Stokes problem, for sticky fluid flowing down a slope.}
\label{fig:ok:slabonslope}
\end{marginfigure}

Because the flow is actually intended to be infinite in the $x$ direction, for a numerical approximation we will require the solution to be periodic in $x$, so the domain is the rectangle $[0,L]\times[0,H]$ (in the rotated coordinates), where $H$ is the thickness and $L$ the length.  We assume a stress-free top and no slip at the base.  Because the normal direction to the top is in the (rotated) $y$-direction, the top boundary condition is
  $$\sigma\cdot\bn = 0 \iff
\begin{bmatrix}
2 \nu u_x - p & \nu (u_y+v_x) \\
\nu (u_y+v_x) & 2 \nu v_y - p
\end{bmatrix} \begin{bmatrix}
0 \\ 1
\end{bmatrix} = \begin{bmatrix}
0 \\ 0
\end{bmatrix}.$$
Thus, with the no-slip base, we have these boundary conditions,
\begin{align}
\text{top $y=H$:}&    & &\begin{array}{l} u_y + v_x = 0 \\ 2 \nu v_y = p\end{array}  \label{eq:ok:bcstokestop} \\
\text{bottom $y=0$:}& & &\begin{array}{l} u = 0 \\ v = 0 \end{array} \label{eq:ok:bcstokesbottom} \\
\text{sides $x=0$ and $x=L$:}&
                      & &u,v,p \text{ are periodic}. \label{eq:ok:bcstokesperiodic}
\end{align}

This boundary-value problem, consisting of field equations \eqref{eq:ok:stokes2du}--\eqref{eq:ok:stokes2dincomp} and boundary conditions \eqref{eq:ok:bcstokestop}--\eqref{eq:ok:bcstokesperiodic}, has a well-known exact solution, which makes this a good example for our first numerical approach:
\begin{align}
u &= \frac{g_1}{\nu} y \left(H - \frac{y}{2}\right), \label{eq:ok:exactstokesu} \\
v &= 0, \label{eq:ok:exactstokesv} \\
p &= -g_2 (H-y).\label{eq:ok:exactstokesp}
\end{align}



\section{Finite element, structured-grid approach}

In this section we apply FIXME to get a symmetric linear system
\begin{equation}
  A \bz = \bbf \label{eq:ok:linsysstokes}
\end{equation}
with block structure FIXME.  As usual we treat the linear problem as nonlinear, and we use a structured grid, so our code has a \pSNES and \pDMDA objects.  We first provide a residual-evaluation routine for the locally-owned part of the structured grid.

FIXME: replace with $Q^2$--$P^{-1}$ finite elements


FIXME: the resulting code is \texttt{stokes.c}


\section{Preconditioners for indefinite systems}

FIXME: while $A$ is symmetric, it is not positive definite; note that if
    $$M = \begin{bmatrix} 0 & G \\ G^\top & 0 \end{bmatrix}$$
and if $M$ has eigenvalue $\lambda$ so that
    $$M \begin{bmatrix} \bx \\ \by \end{bmatrix} = \lambda \begin{bmatrix} \bx \\ \by \end{bmatrix}$$
then
    $$M \begin{bmatrix} -\bx \\ \by \end{bmatrix} = - \lambda \begin{bmatrix} -\bx \\ \by \end{bmatrix}$$
and (w.o.l.o.g.) this is a lin.-indep. eigenvector so $M$ also has eigenvalue $-\lambda$


\section{Exercises}

\renewcommand{\labelenumi}{\arabic{chapter}.\arabic{enumi}\quad}
\begin{enumerate}

\item \label{exer:ok:constantviscositystokes}  Starting from \eqref{eq:ok:graddivudefinition}, by commuting mixed derivatives and using incompressibility show that
\begin{equation*}
\Div \left(\grad \bu^{\top}\right) = \begin{bmatrix}
    \frac{\partial}{\partial x}\left(\Div \bu\right) & \frac{\partial}{\partial y }\left(\Div \bu\right) & \frac{\partial}{\partial x} \left(\Div \bu\right)
    \end{bmatrix}
    = 0.
\end{equation*}
On the other hand,
\begin{equation*}
\Div \left(\grad \bu\right) = \begin{bmatrix} \grad^2 u^x & \grad^2 u^y & \grad^2 u^z \end{bmatrix} = \grad^2 \bu.
\end{equation*}
defines the symbol ``$\grad^2 \bu$.''  Thereby derive \eqref{eq:ok:constantviscositystokes} from \eqref{eq:ok:varstokesmomentum}.

\item \label{exer:ok:weakderive} Derive \eqref{eq:ok:weakstokeswithboundary} from \eqref{eq:ok:constantviscositystokes} and \eqref{eq:ok:constantviscosityincomp}:  Multiply (dot product) by test function $\bv$, integrate over $\Omega$, and expand the vector notation to get
    $$\int_\Omega - \mu \Div (\grad u^x) v^x - \mu \Div (\grad u^y) v^y - \mu \Div (\grad u^z) v^z + \grad p \cdot \bv - \rho \bg \cdot \bv = 0.$$
Then use a product rule and the divergence theorem to convert to
\begin{align*}
   &\int_{\partial \Omega} \left[- \mu v^x \grad u^x - \mu v^y \grad u^y - \mu v^z \grad u^z + p \bv\right] \cdot \bn \\
   &\qquad  + \int_\Omega \mu \grad \bu : \grad \bv - p \Div \bv - \rho \bg \cdot \bv \\
   &= \int_{\partial_N \Omega} \left[- \mu \frac{\partial \bu}{\partial n} + p \bn \right] \cdot \bv + \int_\Omega \mu \grad \bu : \grad \bv - p \Div \bv - \rho \bg \cdot \bv = 0
\end{align*}
where, by definition,
\begin{align*}
\frac{\partial \bu}{\partial n} &= \left<\bn\cdot \grad u^x,\bn\cdot \grad u^y,\bn\cdot \grad u^z\right>, \\
\grad \bu : \grad \bv &= \grad u^x \cdot \grad v^x + \grad u^y \cdot \grad v^y + \grad u^z \cdot \grad v^z.
\end{align*}

\item \label{exer:ok:poiseuilleverify}  Confirm that equations \eqref{eq:ok:poiseuilleexact} exactly solve the constant-viscosity Stokes equations \eqref{eq:ok:constantviscositystokes} and \eqref{eq:ok:constantviscosityincomp}.

\item \label{exer:ok:smalldetails}  FIXME
%f_0 = - \int_\Omega \grad \psi_{-1} \cdot \grad \psi_0
%g_0 = \int_{\square_0} \partial \psi_{-1}/\partial x
%g_2 = \int_{\square_2} \partial \psi_{-1}/\partial x

\end{enumerate}
