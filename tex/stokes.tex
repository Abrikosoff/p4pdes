
\chapter{Systems of PDEs, and the Stokes equations}
\label{chap:stokes}

\section{First-order systems}

FIXME: FOSLS for Poisson?

\section{Stokes equations}

FIXME: lay out theory 

Thus the incompressible variable-viscosity Navier-Stokes has these main equations
\begin{align*}
\rho \left(\frac{\partial \bu}{\partial t} + \bu \cdot \grad \bu\right) &= \Div \sigma + \bg \\
\sigma &= 2 \nu\, Du - p I \\
\Div \bu &= 0
\end{align*}
where
  $$\grad \bu = \renewcommand{\arraystretch}{1.3}\begin{bmatrix}
    \frac{\partial u_1}{\partial x} & \frac{\partial u_2}{\partial x} & \frac{\partial u_3}{\partial x} \\
    \frac{\partial u_1}{\partial y} & \frac{\partial u_2}{\partial y} & \frac{\partial u_3}{\partial y} \\
    \frac{\partial u_1}{\partial z} & \frac{\partial u_2}{\partial z} & \frac{\partial u_3}{\partial z}
    \end{bmatrix}$$
and
    $$D u = \frac{1}{2} \left(\grad \bu + \grad \bu^{\top}\right).$$

FIXME: theory where Froude $\approx 0$

Thus the variable-viscosity Stokes equations, in terms of velocity, are
\begin{align*}
\Div \left(\nu \left(\grad \bu + \grad \bu^{\top}\right)\right) - \grad p &= - \bg \\
\Div \bu &= 0
\end{align*}

We will, however, first consider the case where the viscosity $\nu$ is constant.  In such case the velocity second derivative term can be simplified, and recognized as an application of the Laplacian operator.  Observe that by commuting mixed derivatives and using incompressibility we have
\begin{align*}
\Div \left(\grad \bu^{\top}\right) &= \renewcommand{\arraystretch}{1.3}\begin{bmatrix}
    \frac{\partial}{\partial x} & \frac{\partial}{\partial y} & \frac{\partial}{\partial z}
    \end{bmatrix}
    \begin{bmatrix}
    \frac{\partial u_1}{\partial x} & \frac{\partial u_1}{\partial y} & \frac{\partial u_1}{\partial z} \\
    \frac{\partial u_2}{\partial x} & \frac{\partial u_2}{\partial y} & \frac{\partial u_2}{\partial z} \\
    \frac{\partial u_3}{\partial x} & \frac{\partial u_3}{\partial y} & \frac{\partial u_3}{\partial z}
    \end{bmatrix} \\
  &= \begin{bmatrix}
    \frac{\partial}{\partial x}\left(\Div \bu\right) & \frac{\partial}{\partial y }\left(\Div \bu\right) & \frac{\partial}{\partial x} \left(\Div \bu\right)
    \end{bmatrix}
    = 0.
\end{align*}
On the other hand,
\begin{align*}
\Div \left(\grad \bu\right) &= \renewcommand{\arraystretch}{1.3}\begin{bmatrix}
    \frac{\partial}{\partial x} & \frac{\partial}{\partial y} & \frac{\partial}{\partial z}
    \end{bmatrix}
    \begin{bmatrix}
    \frac{\partial u_1}{\partial x} & \frac{\partial u_2}{\partial x} & \frac{\partial u_3}{\partial x} \\
    \frac{\partial u_1}{\partial y} & \frac{\partial u_2}{\partial y} & \frac{\partial u_3}{\partial y} \\
    \frac{\partial u_1}{\partial z} & \frac{\partial u_2}{\partial z} & \frac{\partial u_3}{\partial z}
    \end{bmatrix} \\
  &= \begin{bmatrix} \grad^2 u_1 & \grad^2 u_2 & \grad^2 u_3 \end{bmatrix} = \grad^2 \bu
\end{align*}
which we have written as ``$\grad^2 \bu$,'' that is, the last equality is a definition.  

Thus we have a Poisson-like problem for $\bu$, but with an unknown pressure playing a role as a source term, in addition to the body force $\bg$.  For consistency with the Poisson equation sign convention in Chapters \ref{chap:structured}--\ref{chap:multigrid}, in the constant viscosity case we write the Stokes equations as
\begin{align}
- \nu \grad^2 \bu + \grad p &= \bg \\
\Div \bu &= 0
\end{align}


\section{A planar-flow problem}

FIXME: reduce to 2D with gravity body force.

\begin{marginfigure}
\begin{tikzpicture}[scale=2.5,rotate=-20]
  \draw[->,gray,very thin] (-0.2,0.0) -- (2.2,0.0) node[below] {$x$};
  \draw[->,gray,very thin] (0.0,-0.2) -- (0.0,1.2) node[left] {$y$};
  \node[xshift=-0.2cm,yshift=-0.13cm] at (0.0,0.0) {$0$};
  \node[xshift=0.0cm,yshift=-0.25cm] at (2.0,0.0) {$L$};
  \node[xshift=-0.25cm,yshift=0.1cm] at (0.0,1.0) {$H$};
  \draw[line width=1.0pt] (0.0,0.0) -- (2.0,0.0);
  \draw[line width=1.0pt] (0.0,1.0) -- (2.0,1.0);
  \node[rotate=-20] at (1.0,-0.1) {no slip: $\bu=0$};
  \node[rotate=-20] at (1.0,1.1) {stress free: $\sigma\cdot\bn=0$};
  \draw[line width=1.5pt,dashed] (0.0,0.0) -- (0.0,1.0);
  \draw[line width=1.3pt,dashed] (2.0,0.0) -- (2.0,1.0);
  \node[rotate=70] at (-0.1,0.5) {periodic};
  \node[rotate=70] at (2.1,0.5) {periodic};
  \draw[line width=1.0pt,dotted] (1.0,0.8) -- node[xshift=-0.2cm,yshift=0.0cm] {$g_2$} (1.0,0.2);
  \draw[line width=1.0pt,dotted] (1.0,0.2) -- node[xshift=0.0cm,yshift=-0.2cm] {$g_1$} (1.2,0.2);
  %>> 0.6 * tan((pi/180)*20)
  %ans =  0.21838
  \draw[->,line width=1.0pt] (1.0,0.8) -- (1.21838,0.2) node[xshift=0.2cm,yshift=0.6cm] {$\bg$};
  \draw[line width=0.7pt] (1.0,0.58) .. controls (1.03,0.575) and (1.04,0.585) .. (1.07,0.6);
  \node at (1.05,0.5) {$\theta$};
\end{tikzpicture}
\caption{Geometry and boundary conditions of our first Stokes problem, for sticky fluid flowing down a slope.}
\label{fig:slabonslope}
\end{marginfigure}

The particular problem we will solve is a constant-thickness flow down a slope, using rotated coordinates as in Figure \ref{fig:slabonslope}.  First we simplify the appearance of the field equations.  Write $u=u_1$ and $v=u_2$.  Then the three scalar equations are
\begin{align}
-\nu \grad^2 u + p_x &= g_1 \label{stokes2du} \\
-\nu \grad^2 v + p_y &= g_2 \label{stokes2dv} \\
u_x + u_y &= 0 \label{stokes2dincomp} 
\end{align}
where $\nu$ is constant and
    $$\bg = (g_1,g_2) = (\rho g \sin \theta, - \rho g \cos \theta).$$

Because the flow is infinite in the $x$ direction, for a numerical approximation we will require the solution to be periodic in $x$, so the domain is a rectangle.  We assume a stress-free top and no slip at the base.  Because the normal direction to the top is in the (rotated) $y$-direction, the top boundary condition is
  $$\sigma\cdot\bn = 0 \iff
\begin{bmatrix}
2 \nu u_x - p & \nu (u_y+v_x) \\
\nu (u_y+v_x) & 2 \nu v_y - p
\end{bmatrix} \begin{bmatrix}
0 \\ 1
\end{bmatrix} = \begin{bmatrix}
0 \\ 0
\end{bmatrix}.$$
Thus, with the no-slip base, we have these boundary conditions,
\begin{align}
\text{top:}&    & &\begin{array}{l} u_y + v_x = 0 \\ 2 \nu v_y = p\end{array} \\
\text{bottom:}& & &\begin{array}{l} u = 0 \\ v = 0 \end{array}
\end{align}



\section{A finite difference, structured-grid approach}

FIXME: Laplacians are something we understand, so lets proceed with eqns \eqref{stokes2du}, \eqref{stokes2dv}; use FD centered

FIXME: any way we do \eqref{stokes2dincomp} we get block structure for the full system $A \bz = \bbf$; informally the structure is
  $$\begin{bmatrix}
    \nu\grad^2 & 0 & -\grad \\
    0 & \nu\grad^2 & -\grad \\
    \grad & \grad & 0
    \end{bmatrix}
    \begin{bmatrix}
    \bu \\ \bv \\ \bp
    \end{bmatrix}
    =
    \begin{bmatrix}
    - g_1 \\ - g_2 \\ 0
    \end{bmatrix}
    $$
but let's write
  $$\begin{bmatrix}
    L & 0 & G_1 \\
    0 & L & G_2 \\
    B_1 & B_2 & 0
    \end{bmatrix}
    \begin{bmatrix}
    \bu \\ \bv \\ \bp
    \end{bmatrix}
    =
    \begin{bmatrix}
    - g_1 \\ - g_2 \\ 0
    \end{bmatrix}
    $$

FIXME: $A$ certainly not invertible if approx to ``$\Div \bu$'' (i.e.~$\begin{bmatrix} B_1 & B_2 \end{bmatrix}$) has more rows than columns

FIXME: extract approx to ``$\Div \bu$'' as transpose of the ``$\grad p$'' part (i.e.~$\begin{bmatrix} G_1 \\ G_2 \end{bmatrix}$); now system is symmetric:
    $$\begin{bmatrix}
    L & 0 & G_1 \\
    0 & L & G_2 \\
    G_1^\top & G_2^\top & 0
    \end{bmatrix}
    \begin{bmatrix}
    \bu \\ \bv \\ \bp
    \end{bmatrix}
    =
    \begin{bmatrix}
    - g_1 \\ - g_2 \\ 0
    \end{bmatrix}
    \quad \iff \quad A\bz = \bbf
    $$

FIXME: not the best way but illuminating; code uses DMDA and SNES

\section{Preconditioners for indefinite systems}

FIXME: while $A$ is symmetric, it is not positive definite; note that if
    $$M = \begin{bmatrix} 0 & G \\ G^\top & 0 \end{bmatrix}$$
and if $M$ has eigenvalue $\lambda$ so that
    $$M \begin{bmatrix} \bx \\ \by \end{bmatrix} = \lambda \begin{bmatrix} \bx \\ \by \end{bmatrix}$$
then
    $$M \begin{bmatrix} -\bx \\ \by \end{bmatrix} = - \lambda \begin{bmatrix} -\bx \\ \by \end{bmatrix}$$
and (w.o.l.o.g.) this is a lin.-indep. eigenvector so $M$ also has eigenvalue $-\lambda$



\caveat{But \PETSc should help with unstructured meshes too.}

