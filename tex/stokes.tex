
\chapter{Systems of PDEs, and the Stokes equations}
\label{chap:stokes}

\section{First-order systems}

FIXME: FOSLS for Poisson?

\section{Stokes equations}

FIXME: lay out theory e.g.~from \citep{Acheson1990,Elmanetal2005,Ockendonetal2003}

Thus the incompressible variable-viscosity Navier-Stokes has these main equations
\begin{align}
\rho \left(\frac{\partial \bu}{\partial t} + \bu \cdot \grad \bu\right) &= \Div \sigma + \bg \label{stokesgeneralconserve} \\
\sigma &= 2 \nu\, Du - p I \label{stokesgenerallaw} \\
\Div \bu &= 0 \label{stokesgeneralincomp}
\end{align}
where
  $$\grad \bu = \renewcommand{\arraystretch}{1.3}\begin{bmatrix}
    \frac{\partial u_1}{\partial x} & \frac{\partial u_2}{\partial x} & \frac{\partial u_3}{\partial x} \\
    \frac{\partial u_1}{\partial y} & \frac{\partial u_2}{\partial y} & \frac{\partial u_3}{\partial y} \\
    \frac{\partial u_1}{\partial z} & \frac{\partial u_2}{\partial z} & \frac{\partial u_3}{\partial z}
    \end{bmatrix}
    \quad \text{ and } \quad
    D u = \frac{1}{2} \left(\grad \bu + \grad \bu^{\top}\right).$$

FIXME: theory where Froude $\approx 0$

Thus the variable-viscosity Stokes equations, in terms of velocity, are
\begin{align*}
- \Div \left(\nu \left(\grad \bu + \grad \bu^{\top}\right)\right) + \grad p &= \bg \\
\Div \bu &= 0
\end{align*}

We will, however, first consider the case where the viscosity $\nu$ is constant.  In such case the velocity second derivative term can be simplified, and recognized as an application of the Laplacian operator.  Observe that by commuting mixed derivatives and using incompressibility we have
\begin{align*}
\Div \left(\grad \bu^{\top}\right) &= \renewcommand{\arraystretch}{1.3}\begin{bmatrix}
    \frac{\partial}{\partial x} & \frac{\partial}{\partial y} & \frac{\partial}{\partial z}
    \end{bmatrix}
    \begin{bmatrix}
    \frac{\partial u_1}{\partial x} & \frac{\partial u_1}{\partial y} & \frac{\partial u_1}{\partial z} \\
    \frac{\partial u_2}{\partial x} & \frac{\partial u_2}{\partial y} & \frac{\partial u_2}{\partial z} \\
    \frac{\partial u_3}{\partial x} & \frac{\partial u_3}{\partial y} & \frac{\partial u_3}{\partial z}
    \end{bmatrix} \\
  &= \begin{bmatrix}
    \frac{\partial}{\partial x}\left(\Div \bu\right) & \frac{\partial}{\partial y }\left(\Div \bu\right) & \frac{\partial}{\partial x} \left(\Div \bu\right)
    \end{bmatrix}
    = 0.
\end{align*}
On the other hand,
\begin{align*}
\Div \left(\grad \bu\right) &= \renewcommand{\arraystretch}{1.3}\begin{bmatrix}
    \frac{\partial}{\partial x} & \frac{\partial}{\partial y} & \frac{\partial}{\partial z}
    \end{bmatrix}
    \begin{bmatrix}
    \frac{\partial u_1}{\partial x} & \frac{\partial u_2}{\partial x} & \frac{\partial u_3}{\partial x} \\
    \frac{\partial u_1}{\partial y} & \frac{\partial u_2}{\partial y} & \frac{\partial u_3}{\partial y} \\
    \frac{\partial u_1}{\partial z} & \frac{\partial u_2}{\partial z} & \frac{\partial u_3}{\partial z}
    \end{bmatrix} \\
  &= \begin{bmatrix} \grad^2 u_1 & \grad^2 u_2 & \grad^2 u_3 \end{bmatrix} = \grad^2 \bu.
\end{align*}
The last equality defines symbols ``$\grad^2 \bu$.''

In the constant viscosity case we write the Stokes equations as
\begin{align}
- \nu \grad^2 \bu + \grad p &= \bg \\
\Div \bu &= 0
\end{align}
This is a Poisson-like problem for $\bu$, but with an unknown pressure generating a source term, in addition to the body force $\bg$.

\section{Fluid flowing down a slope}

FIXME: reduce to 2D with gravity body force.

The particular problem we will solve is a constant-thickness flow down a slope of angle $\theta$, using rotated coordinates as in Figure \ref{fig:slabonslope}.  First we simplify the appearance of the field equations.  Write $u=u_1$ and $v=u_2$.  Then the three scalar equations are
\begin{align}
-\nu \grad^2 u + p_x &= g_1 \label{stokes2du} \\
-\nu \grad^2 v + p_y &= g_2 \label{stokes2dv} \\
u_x + v_y &= 0 \label{stokes2dincomp}
\end{align}
where $\nu$ is constant and $\bg = (g_1,g_2) = (\rho g \sin \theta, - \rho g \cos \theta)$.

\begin{marginfigure}
\begin{tikzpicture}[scale=2.5,rotate=-20]
  \draw[->,gray,very thin] (-0.2,0.0) -- (2.2,0.0) node[below] {$x$};
  \draw[->,gray,very thin] (0.0,-0.2) -- (0.0,1.2) node[left] {$y$};
  \node[xshift=-0.2cm,yshift=-0.13cm] at (0.0,0.0) {$0$};
  \node[xshift=0.0cm,yshift=-0.25cm] at (2.0,0.0) {$L$};
  \node[xshift=-0.25cm,yshift=0.1cm] at (0.0,1.0) {$H$};
  \draw[line width=1.0pt] (0.0,0.0) -- (2.0,0.0);
  \draw[line width=1.0pt] (0.0,1.0) -- (2.0,1.0);
  \node[rotate=-20] at (1.0,-0.1) {no slip: $\bu=0$};
  \node[rotate=-20] at (1.0,1.1) {stress free: $\sigma\cdot\bn=0$};
  \draw[line width=1.5pt,dashed] (0.0,0.0) -- (0.0,1.0);
  \draw[line width=1.3pt,dashed] (2.0,0.0) -- (2.0,1.0);
  \node[rotate=70] at (-0.1,0.5) {periodic};
  \node[rotate=70] at (2.1,0.5) {periodic};
  \draw[line width=1.0pt,dotted] (1.0,0.8) -- node[xshift=-0.2cm,yshift=0.0cm] {$g_2$} (1.0,0.2);
  \draw[line width=1.0pt,dotted] (1.0,0.2) -- node[xshift=0.0cm,yshift=-0.2cm] {$g_1$} (1.2,0.2);
  %>> 0.6 * tan((pi/180)*20)
  %ans =  0.21838
  \draw[->,line width=1.0pt] (1.0,0.8) -- (1.21838,0.2) node[xshift=0.2cm,yshift=0.6cm] {$\bg$};
  \draw[line width=0.7pt] (1.0,0.58) .. controls (1.03,0.575) and (1.04,0.585) .. (1.07,0.6);
  \node at (1.05,0.5) {$\theta$};
\end{tikzpicture}
\caption{Geometry and boundary conditions of our first Stokes problem, for sticky fluid flowing down a slope.}
\label{fig:slabonslope}
\end{marginfigure}

Because the flow is actually intended to be infinite in the $x$ direction, for a numerical approximation we will require the solution to be periodic in $x$, so the domain is the rectangle $[0,L]\times[0,H]$ (in the rotated coordinates), where $H$ is the thickness and $L$ the length.  We assume a stress-free top and no slip at the base.  Because the normal direction to the top is in the (rotated) $y$-direction, the top boundary condition is
  $$\sigma\cdot\bn = 0 \iff
\begin{bmatrix}
2 \nu u_x - p & \nu (u_y+v_x) \\
\nu (u_y+v_x) & 2 \nu v_y - p
\end{bmatrix} \begin{bmatrix}
0 \\ 1
\end{bmatrix} = \begin{bmatrix}
0 \\ 0
\end{bmatrix}.$$
Thus, with the no-slip base, we have these boundary conditions,
\begin{align}
\text{top $y=H$:}&    & &\begin{array}{l} u_y + v_x = 0 \\ 2 \nu v_y = p\end{array}  \label{bcstokestop} \\
\text{bottom $y=0$:}& & &\begin{array}{l} u = 0 \\ v = 0 \end{array} \label{bcstokesbottom} \\
\text{sides $x=0$ and $x=L$:}&
                      & &u,v,p \text{ are periodic}. \label{bcstokesperiodic}
\end{align}

This boundary-value problem, consisting of field equations \eqref{stokes2du}--\eqref{stokes2dincomp} and boundary conditions \eqref{bcstokestop}--\eqref{bcstokesperiodic}, has a well-known exact solution, which makes this a good example for our first numerical approach:
\begin{align}
u &= \frac{g_1}{\nu} y \left(H - \frac{y}{2}\right), \label{exactstokesu} \\
v &= 0, \label{exactstokesv} \\
p &= -g_2 (H-y).\label{exactstokesp}
\end{align}
It is not hard to explain how this solution is derived.  First, the solution of the problem is unique by standard arguments with the weak formulation \citep[p.~223]{Elmanetal2005}.  Thus the solution is independent of $x$ because the transformation $x\mapsto x+c$ changes none of the equations or boundary conditions.  Next, by \eqref{stokes2du} and boundary conditions \eqref{bcstokestop}, \eqref{bcstokesbottom}, $u=u(y)$ solves the easy two-point boundary value problem $-\nu u_{yy} = g_1$, $u(0)=0$, $u_y(H)=0$ which gives \eqref{exactstokesu}.  But then by \eqref{stokes2dincomp} and the boundary condition \eqref{bcstokesbottom}, $v=0$.  Finally for the pressure $p=p(y)$, equations \eqref{stokes2dv} and \eqref{bcstokestop} say $p_y=g_2$ and $p(H)=0$ thus \eqref{exactstokesp}.


\section{Block structure of numerical Stokes solvers}

FIXME: Laplacians are something we understand, so lets proceed with eqns \eqref{stokes2du}, \eqref{stokes2dv}

FIXME: any way we do \eqref{stokes2dincomp} we get block structure for the full system ``$A \bz = \bbf$.''  Informally the structure is
  $$\begin{bmatrix}
    -\nu\grad^2 & 0 & \partial/\partial x \\
    0 & -\nu\grad^2 & \partial/\partial y \\
    \partial/\partial x & \partial/\partial y & 0
    \end{bmatrix}
    \begin{bmatrix}
    \bu \\ \bv \\ \bp
    \end{bmatrix}
    =
    \begin{bmatrix}
    g_1 \\ g_2 \\ 0
    \end{bmatrix}
    $$
but let's write
  $$\begin{bmatrix}
    \nu L_1 & 0 & G_1 \\
    0 & \nu L_2 & G_2 \\
    B_1 & B_2 & 0
    \end{bmatrix}
    \begin{bmatrix}
    \bu \\ \bv \\ \bp
    \end{bmatrix}
    =
    \begin{bmatrix}
    g_1 \\ g_2 \\ 0
    \end{bmatrix}
    $$
where $L_i$, $G_i$, $B_i$ are matrices.  We expect that Laplacian-approximation matrices $L_1$ and $L_2$, which essentially differ only in their boundary conditions, can be built as symmetric positive-definite matrices.

FIXME: $A$ certainly not invertible if approx to ``$\Div \bu$'' (i.e.~$\begin{bmatrix} B_1 & B_2 \end{bmatrix}$) has more rows than columns

FIXME: extract approx to ``$\Div \bu$'' as transpose of the ``$\grad p$'' part (i.e.~$G_i$) so that
    $$\begin{bmatrix}
    \nu L_1 & 0 & G_1 \\
    0 & \nu L_1 & G_2 \\
    G_1^\top & G_2^\top & 0
    \end{bmatrix}
    \begin{bmatrix}
    \bu \\ \bv \\ \bp
    \end{bmatrix}
    =
    \begin{bmatrix}
    g_1 \\ g_2 \\ 0
    \end{bmatrix}$$
Now system is symmetric, but not positive definite.

Before proceeding let us observe that the pressure can be seen to solve its own equation, at least assuming smoothness of the solution to \eqref{stokes2du}--\eqref{stokes2dincomp}.  By taking the $x$ and $y$ derivatives of \eqref{stokes2dincomp} we get equations $u_{xx} + v_{yx} = 0$ and $u_{xy} + v_{yy} = 0$.  These allow us to replace $u_{xx}$ and $v_{yy}$ in \eqref{stokes2du}, \eqref{stokes2dv} with mixed derivatives, respectively, to get:
\begin{align}
-\nu \left(-v_{yx} + u_{yy}\right) + p_x &= g_1 \label{mixedstokes2du} \\
-\nu \left(v_{xx} - u_{xy}\right) + p_y &= g_2 \label{mixedstokes2dv}
\end{align}
Now, taking the $x$ derivative of \eqref{mixedstokes2du} and the $y$-derivative of \eqref{mixedstokes2dv}, and noting $g_i$ are constant, and adding the results, the velocity derivatives cancel entirely.  We conclude that $p$ actually solves Laplace's equation,
\begin{equation}
\grad^2 p = 0. \label{pressurepoisson}
\end{equation}
The derivation here is not original; we have arrived at the well-known \emph{pressure-Poisson} equation \citep{Ockendonetal2003}.

The appearance of the Laplacian in a decoupled equation opens up the possibility that we can make our linear system ``more positive definite'' by adding a multiple of equation \eqref{pressurepoisson} to the Stokes system.  Concretely, if $\eps\ge 0$ then this system is equivalent to \eqref{stokes2du}--\eqref{stokes2dincomp}:
\begin{align}
-\nu \grad^2 u + p_x &= g_1 \label{ppstokes2du} \\
-\nu \grad^2 v + p_y &= g_2 \label{ppstokes2dv} \\
u_x + u_y - \eps \grad^2 p &= 0 \label{ppstokes2dincomp}
\end{align}
These equations correspond to block structure of the numerical approximation,
\begin{equation}
\begin{bmatrix}
    \nu L_1 & 0 & G_1 \\
    0 & \nu L_1 & G_2 \\
    G_1^\top & G_2^\top & \eps L_3
    \end{bmatrix}
    \begin{bmatrix}
    \bu \\ \bv \\ \bp
    \end{bmatrix}
    =
    \begin{bmatrix}
    g_1 \\ g_2 \\ 0
    \end{bmatrix} \label{blockppstokes}
\end{equation}
which we write as $A\bz = \bbf$ for the rest of this Chapter.  We show parameters $\nu>0$ and $\eps \in \RR$ to emphasize that we can play with problems of different viscosity and with more or less pressure-Poisson regularization, respectively. 


\section{A finite difference, structured-grid approach}

In this section we apply centered finite differences to equations \eqref{ppstokes2du}--\eqref{ppstokes2dincomp} using boundary conditions \eqref{bcstokestop}--\eqref{bcstokesperiodic} to get a symmetric linear system
\begin{equation}
  A \bz = \bbf \label{linsysstokes}
\end{equation}
with block structure \eqref{blockppstokes}.  We do not, however, describe this linear system to \PETSc using \pMat for $A$ and a \pVec for $\bbf$ in \eqref{linsysstokes}.  Rather we treat the linear problem as nonlinear, following the examples in Chapter \ref{chap:nonlinear}.  Because we are using a structured grid managed by a \PETSc \pDMDA object, we provide a residual-evaluation routine for the locally-owned part of the structured grid.

To get started on the FD equations, and recalling the notation from Chapter \ref{chap:structured}, suppose that we have a grid of \texttt{Mx} points in the $x$ direction and \texttt{My} points in the $y$ direction.  Periodicity in the $x$ direction means that there is a difference in the computation of grid spacing:
\begin{equation}
h_x = \frac{L}{\text{\texttt{Mx}}}, \qquad h_y = \frac{H}{\text{\texttt{My}}-1}. \label{hdefinestokes}
\end{equation}
The reason for the difference is suggested by Figure \ref{fig:xperiodicgrid}, where we see that each grid point along the $x$-axis represents an entire grid cell, while in the $y$ direction the first and last grid points represent boundary locations.  Of course the main idea of periodicity is that left neighbors of $i=0$ grid locations are ``wrapped-around'' to the right-most grid points, while right neighbors of $i=\text{\texttt{Mx}}-1$ locations are wrapped to the left-most grid points.

\begin{marginfigure}
\begin{tikzpicture}[scale=2.2]
  \draw[->,gray,very thin] (0.0,0.0) -- (2.2,0.0) node[below] {$x$};
  \draw[->,gray,very thin] (0.0,0.0) -- (0.0,1.3) node[left] {$y$};
  \draw[line width=1.0pt] (0.0,0.0) -- (2.0,0.0);
  \draw[line width=1.0pt] (0.0,1.0) -- (2.0,1.0);
  \draw[line width=1.5pt,dashed] (0.0,0.0) -- (0.0,1.0);
  \draw[line width=1.3pt,dashed] (2.0,0.0) -- (2.0,1.0);
  \pgfmathsetmacro\fourth{1.0/4.0}
  \pgfmathsetmacro\third{1.0/3.0}
  \node at (0.0,-0.15) {$i=0$};
  \node at (1.85-\third,-0.15) {$i=\text{\texttt{Mx}}-1$};
  \node at (-0.2,0.0) {$j=0$};
  \node at (-0.35,1.0) {$j=\text{\texttt{My}}-1$};
  \draw[xstep=2.0*\fourth,ystep=\third,black,thin] (0.0,0.0) grid (2.0,1.0);
  \foreach \x in {0,...,3} {
    \foreach \y in {0,...,3} {
        \filldraw (\x * 2.0 * \fourth,\y * \third) circle (0.7pt);
    }
  }
\end{tikzpicture}
\caption{Because the grid is periodic in $x$, but not in $y$, the computation of $h_x$ and $h_y$ follows formulas \eqref{hdefinestokes}.}
\label{fig:xperiodicgrid}
\end{marginfigure}

The FD equations for interior points, including the periodic boundaries, (i.e.~any $i$ but $0 < j < \text{\texttt{My}}-1$) are the approximations to equations \eqref{ppstokes2du}--\eqref{ppstokes2dincomp}:
\begin{align}
-\nu \Big(\frac{u_{i+1,j} - 2 u_{i,j} + u_{i-1,j}}{h_x^2} &+ \frac{u_{i,j+1} - 2 u_{i,j} + u_{i,j-1}}{h_y^2}\Big) \notag \\
&\qquad + \frac{p_{i+1,j}-p_{i-1,j}}{2h_x} - g_1 = 0 \label{fdstokes2du} \\
-\nu \Big(\frac{v_{i+1,j} - 2 v_{i,j} + v_{i-1,j}}{h_x^2} &+ \frac{v_{i,j+1} - 2 v_{i,j} + v_{i,j-1}}{h_y^2}\Big) \notag \\
&\qquad + \frac{p_{i,j+1}-p_{i,j-1}}{2h_y} - g_2 = 0 \label{fdstokes2dv} \\
\frac{u_{i+1,j}-u_{i-1,j}}{2h_x} + \frac{v_{i,j+1}-v_{i,j-1}}{2h_y} &- \eps \Big(\frac{p_{i+1,j} - 2 p_{i,j} + p_{i-1,j}}{h_x^2} \notag \\
&\qquad\quad + \frac{p_{i,j+1} - 2 p_{i,j} + p_{i,j-1}}{h_y^2}\Big) = 0 \label{fdstokes2dincomp}
\end{align}
In the above formulas, so as to address periodicity in the $x$ direction, in the case $i=0$ we interpret ``$i-1$'' subscripts as $\text{\texttt{Mx}}-1$, while if $i=\text{\texttt{Mx}}-1$ then we interpret ``$i+1$'' subscripts as $0$.

At the bottom $y=0$ we set fields from the Dirichlet boundary conditions \eqref{bcstokesbottom}, and from the exact solution for $p$:
\begin{equation}
  u_{i,0} = v_{i,0} = 0, \quad p_{i,0} = - g_2 H. \label{fdbcstokesbottom}
\end{equation}
The top $y=H$ boundary conditions \eqref{bcstokestop} require care.  Let $J=\text{\texttt{My}}-1$, the upper most index in the $y$ direction.  We set $p$ from the exact solution, $p_{i,J} = 0$.  Approximating the first of equations \eqref{bcstokestop} at $(x_i,y_J)$ by centered FD formulas gives
\begin{equation}
  \frac{u_{i,J+1}-u_{i,J-1}}{2h_y} + \frac{v_{i+1,J}-v_{i-1,J}}{2h_x} = 0, \label{earlyfdbcstokestop}
\end{equation}
but the notional point ``$u_{i,J+1}$'' is outside the domain.  We add equation \eqref{fdstokes2du} at the same point, solved for $u_{i,J+1}$,
\begin{equation}
%  -\nu \Big(\frac{u_{i+1,J} - 2 u_{i,J} + u_{i-1,J}}{h_x^2} + \frac{u_{i,J+1} - 2 u_{i,J} + u_{i,J-1}}{h_y^2}\Big) - g_1 = 0 \label{earlyfdstokes2dutop} 
  u_{i,J+1} = 2 u_{i,J} - u_{i,J-1} - h_y^2 \left(\frac{g_1}{\nu} + \frac{u_{i+1,J} - 2 u_{i,J} + u_{i-1,J}}{h_x^2}\right) \label{earlyfdstokes2dutop} 
\end{equation}
and incorporating $p_{i-1,J}=p_{i+1,J}=0$ also, and substitute this into \eqref{earlyfdbcstokestop}.  Finally, the second of equations \eqref{bcstokestop} says $v_y=0$ at $(x_i,y_J)$ because $p_{i,J}=0$, so $v_{i,J+1} = v_{i,J-1}$ from the centered FD approximation.  But then \eqref{fdstokes2dv} and \eqref{fdstokes2dincomp} become the pair of equations
\begin{align}
-\nu \Big(\frac{v_{i+1,J} - 2 v_{i,J} + v_{i-1,J}}{h_x^2} + \frac{2 v_{i,J-1} - 2 v_{i,J}}{h_y^2}\Big) + \frac{p_{i,J+1}-p_{i,J-1}}{2h_y} - g_2 = 0 \label{fdtopv} \\
\frac{u_{i+1,J}-u_{i-1,J}}{2h_x}  - \eps \frac{p_{i,J+1} + p_{i,J-1}}{h_y^2} = 0. \label{earlytoppressure}
\end{align}
These equations both have the notional ``$p_{i,J+1}$,'' so we eliminate it by rewriting equation \eqref{earlytoppressure},
\begin{equation}
p_{i,J+1} = \frac{h_y^2}{\eps} \frac{u_{i+1,J}-u_{i-1,J}}{2h_x} - p_{i,J-1},\label{fdtoppressureelim}
\end{equation}
which is substituted into \eqref{fdtopv}.

\section{Preconditioners for indefinite systems}

FIXME: while $A$ is symmetric, it is not positive definite; note that if
    $$M = \begin{bmatrix} 0 & G \\ G^\top & 0 \end{bmatrix}$$
and if $M$ has eigenvalue $\lambda$ so that
    $$M \begin{bmatrix} \bx \\ \by \end{bmatrix} = \lambda \begin{bmatrix} \bx \\ \by \end{bmatrix}$$
then
    $$M \begin{bmatrix} -\bx \\ \by \end{bmatrix} = - \lambda \begin{bmatrix} -\bx \\ \by \end{bmatrix}$$
and (w.o.l.o.g.) this is a lin.-indep. eigenvector so $M$ also has eigenvalue $-\lambda$



\caveat{But \PETSc should help with unstructured meshes too.}

