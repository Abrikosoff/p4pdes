
\section{A variational inequality problem}

On a square $R = [-2,2]\times [-2,2]$.  Suppose $\psi \in H^1(R)$ has $\psi\big|_{\partial R} \le 0$ (in a trace sense).  Suppose we have $g\in L^2(\partial R)$ where $g \ge 0$ a.e.~on $\partial R$.  Consider the problem of finding $u\in H_0^1(R)$ so that
\begin{equation}
    \grad^2 u = 0 \text{ on } \{u > \psi\} \text{ \emph{and} } u\ge \psi. \label{obstaclestrong}
\end{equation}

This obstacle problem is nonlinear even though the Laplace equation is $\grad^2 u = 0$ is linear.

This obstacle problem is equivalent to minimization of the functional
\begin{equation}
I[u] = \frac{1}{2} \int_R \grad u\cdot \grad u
\end{equation}
over the constraint set
\begin{equation}
\mathcal{K} = \left\{u \in H_0^1(R) \,\Big|\, u\ge \psi\right\}.
\end{equation}

The code we write solves a problem where the exact solution is known for the given $\psi$ and boundary values in question.  In this case
   $$\psi(x,y) = \begin{cases} 1 - r^2, & r \le 1, \\  0, & \text{otherwise},\end{cases}$$
where, as expected, $r = (x^2+y^2)^{1/2}$.% FIXME: \psi is not in H^1, technically
Then the exact solution is
   $$u_{\text{exact}}(x,y) = \begin{cases} \psi(x,y), & r \le r_{\text{free}}, \\  - A \ln(r) + B, & \text{otherwise},\end{cases}$$
where $r_{\text{free}} = 0.69797$, $A = 0.68026$, and $B = 0.47152$.

\cinputpart{obstacle.c}{\CODELOC}{Just the struct.}{I}{//STRUCT}{//ENDSTRUCT}{code:obstaclestruct}

\cinputpart{obstacle.c}{\CODELOC}{Create the DMDA and Vecs.}{II}{//CREATE}{//ENDCREATE}{code:obstaclecreate}

\cinputpart{obstacle.c}{\CODELOC}{Setup the SNESVI object.}{III}{//SETUPSNES}{//ENDSETUPSNES}{code:obstaclesetupsnes}

\cinputpart{obstacle.c}{\CODELOC}{Compute the function $\psi$ and the exact solution, which determines the boundary conditions.}{IV}{//FORMPSI}{//ENDFORMPSI}{code:obstacleformpsi}

\cinputpart{obstacle.c}{\CODELOC}{From \PETSc 's point of view we are solving ``$F(u)=0$ subject to $u\ge \psi$''; this method computes $F(u)$.}{V}{//FORMFUNC}{//ENDFORMFUNC}{code:obstacleformfunc}

\cinputpart{obstacle.c}{\CODELOC}{This method assembles the Jacobian $J = F'(u)$.}{VI}{//FORMJAC}{//ENDFORMJAC}{code:obstacleformjac}

\cinputpart{obstacle.c}{\CODELOC}{An important part: tell SNESVI object about bound $u\ge \psi$ (and $u<+\infty$ because SNESVI expects both upper and lower bounds).}{VII}{//FORMBOUNDS}{//ENDFORMBOUNDS}{code:obstacleformbounds}

\cinputpart{obstacle.c}{\CODELOC}{Solve and report on results.}{VIII}{//SOLVE}{//ENDSOLVE}{code:obstaclesolve}

\section{Ice sheets}


%\section{General linear constraints}
%Date: Sat, 22 Aug 2015 21:29:25 -0500
%From: Barry Smith <bsmith@mcs.anl.gov>
%To: David Knezevic <david.knezevic@akselos.com>
%Cc: PETSc users list <petsc-users@mcs.anl.gov>
%Subject: Re: [petsc-users] Variatonal inequalities
%
%  David,
%
%   Currently the only way to do this without adding a lot of additional PETSc code is to add additional variables such that only box constraints appear in the final problem. For example say you have constraints   c <= Ax <= d then introduce new variables y = Ax and then you have the larger problem of unknowns (x,y) and box constrains on y with -infinity and +infinity constraints on x.
%
%  Barry
%
%> On Aug 22, 2015, at 6:59 AM, David Knezevic <david.knezevic@akselos.com> wrote:
%> Hi all,
%> I see from Section 5.7 of the manual that SNES supports box constraints on variables, which is great. However, I was also hoping to also be able to consider general linear inequality constraints, so I was wondering if anyone has any suggestions on how (or if) that could be done with PETSc?
%> Thanks,
%> David